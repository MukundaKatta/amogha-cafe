<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Amogha Admin - Orders</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Playfair+Display:wght@500;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link rel="icon" href="../amogha-logo.png">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#D4A017">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Amogha Admin">
    <link rel="apple-touch-icon" href="../amogha-logo.png">
    <style>
        :root {
            --primary: #8B1A1A;
            --gold: #D4A017;
            --gold-light: #e8c547;
            --gold-dark: #B8860B;
            --gold-glow: rgba(212, 160, 23, 0.25);
            --dark: #0f0a07;
            --dark-card: #1a0f08;
            --dark-warm: #2c1810;
            --cream: #e8dcc8;
            --text-muted: #8a7a6a;
            --text-dim: #6a5a4a;
            --text-faint: #4a3a2a;
            --radius: 14px;
            --transition: 0.3s cubic-bezier(0.22, 1, 0.36, 1);
        }

        *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Poppins', sans-serif;
            background: var(--dark);
            color: var(--cream);
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Grain texture */
        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.03'/%3E%3C/svg%3E");
            pointer-events: none;
            z-index: 1000;
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, var(--gold), var(--gold-dark));
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb:hover { background: var(--gold-light); }

        /* ─── LOGIN SCREEN ─── */
        .admin-login {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 2rem;
            position: relative;
        }

        /* Login background aura */
        .admin-login::before {
            content: '';
            position: absolute;
            top: 30%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 500px;
            height: 500px;
            background: radial-gradient(ellipse, rgba(212, 160, 23, 0.08) 0%, transparent 70%);
            animation: loginAura 6s ease-in-out infinite;
            pointer-events: none;
        }

        @keyframes loginAura {
            0%, 100% { opacity: 0.5; transform: translate(-50%, -50%) scale(1); }
            50% { opacity: 1; transform: translate(-50%, -50%) scale(1.15); }
        }

        .login-box {
            background: rgba(26, 15, 8, 0.85);
            backdrop-filter: blur(24px);
            -webkit-backdrop-filter: blur(24px);
            border: 1px solid rgba(212, 160, 23, 0.15);
            border-radius: 20px;
            padding: 2.5rem;
            max-width: 400px;
            width: 100%;
            text-align: center;
            position: relative;
            z-index: 1;
            box-shadow: 0 8px 40px rgba(0, 0, 0, 0.4), 0 0 80px rgba(212, 160, 23, 0.04);
            animation: loginIn 0.8s cubic-bezier(0.22, 1, 0.36, 1);
        }

        @keyframes loginIn {
            0% { opacity: 0; transform: translateY(30px) scale(0.96); }
            100% { opacity: 1; transform: translateY(0) scale(1); }
        }

        .login-logo {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            margin-bottom: 1.5rem;
            animation: logoFloat 4s ease-in-out infinite;
            filter: drop-shadow(0 4px 16px rgba(212, 160, 23, 0.2));
        }

        @keyframes logoFloat {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-8px); }
        }

        .login-box h2 {
            font-family: 'Playfair Display', serif;
            color: var(--gold);
            margin-bottom: 0.3rem;
            font-size: 1.5rem;
        }

        .login-box p {
            color: var(--text-muted);
            font-size: 0.85rem;
            margin-bottom: 1.5rem;
        }

        .login-box input {
            width: 100%;
            padding: 0.9rem 1rem;
            background: rgba(255, 255, 255, 0.04);
            border: 1.5px solid rgba(212, 160, 23, 0.12);
            border-radius: 12px;
            color: var(--cream);
            font-family: 'JetBrains Mono', monospace;
            font-size: 1rem;
            margin-bottom: 1rem;
            text-align: center;
            letter-spacing: 0.4em;
            transition: all var(--transition);
        }

        .login-box input:focus {
            outline: none;
            border-color: var(--gold);
            box-shadow: 0 0 0 4px rgba(212, 160, 23, 0.1), 0 0 20px rgba(212, 160, 23, 0.08);
            background: rgba(255, 255, 255, 0.06);
        }

        .login-box input::placeholder {
            letter-spacing: normal;
            color: var(--text-dim);
            font-family: 'Poppins', sans-serif;
        }

        .login-btn {
            width: 100%;
            padding: 0.9rem;
            background: linear-gradient(135deg, var(--gold), var(--gold-dark));
            color: var(--dark-card);
            border: none;
            border-radius: 12px;
            font-family: 'Poppins', sans-serif;
            font-size: 0.95rem;
            font-weight: 700;
            cursor: pointer;
            transition: all var(--transition);
            position: relative;
            overflow: hidden;
        }

        .login-btn::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 24px rgba(212, 160, 23, 0.35);
        }

        .login-btn:hover::after {
            left: 100%;
        }

        .login-error {
            color: #e74c3c;
            font-size: 0.82rem;
            margin-top: 0.5rem;
            min-height: 1.2em;
        }

        /* ─── ADMIN HEADER ─── */
        .admin-header {
            background: linear-gradient(135deg, rgba(26, 15, 8, 0.95), rgba(44, 24, 16, 0.95));
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            padding: 1rem 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid rgba(212, 160, 23, 0.12);
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.3);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .header-logo {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            filter: drop-shadow(0 2px 8px rgba(212, 160, 23, 0.2));
        }

        .admin-header h1 {
            font-family: 'Playfair Display', serif;
            color: var(--gold);
            font-size: 1.3rem;
            font-weight: 700;
        }

        .admin-header h1 span {
            color: var(--gold-light);
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 1.2rem;
        }

        .admin-stats {
            display: flex;
            gap: 0.75rem;
            font-size: 0.8rem;
        }

        .stat-badge {
            background: rgba(212, 160, 23, 0.06);
            border: 1px solid rgba(212, 160, 23, 0.12);
            padding: 0.4rem 0.9rem;
            border-radius: 20px;
            color: var(--text-muted);
            font-weight: 500;
            transition: all var(--transition);
        }

        .stat-badge:hover {
            border-color: rgba(212, 160, 23, 0.25);
            background: rgba(212, 160, 23, 0.1);
        }

        .stat-badge .num {
            color: var(--gold-light);
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.82rem;
        }

        /* Live indicator */
        .live-label {
            font-size: 0.78rem;
            color: #27ae60;
            display: flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.35rem 0.8rem;
            background: rgba(39, 174, 96, 0.08);
            border: 1px solid rgba(39, 174, 96, 0.15);
            border-radius: 20px;
        }

        .live-dot {
            width: 7px;
            height: 7px;
            background: #27ae60;
            border-radius: 50%;
            display: inline-block;
            position: relative;
        }

        .live-dot::after {
            content: '';
            position: absolute;
            inset: -3px;
            border: 2px solid rgba(39, 174, 96, 0.3);
            border-radius: 50%;
            animation: livePulse 2s ease-out infinite;
        }

        @keyframes livePulse {
            0% { transform: scale(1); opacity: 1; }
            100% { transform: scale(2); opacity: 0; }
        }

        /* ─── FILTERS ─── */
        .filters {
            padding: 1rem 2rem;
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            border-bottom: 1px solid rgba(212, 160, 23, 0.06);
        }

        .filter-btn {
            padding: 0.45rem 1.1rem;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(212, 160, 23, 0.08);
            border-radius: 20px;
            color: var(--text-dim);
            font-family: 'Poppins', sans-serif;
            font-size: 0.8rem;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition);
        }

        .filter-btn:hover {
            background: rgba(212, 160, 23, 0.08);
            color: var(--text-muted);
            border-color: rgba(212, 160, 23, 0.15);
        }

        .filter-btn.active {
            background: rgba(212, 160, 23, 0.12);
            border-color: var(--gold);
            color: var(--gold);
            box-shadow: 0 0 12px rgba(212, 160, 23, 0.1);
        }

        /* ─── ORDERS GRID ─── */
        .orders-container {
            padding: 1.2rem 2rem 2rem;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(min(360px, 100%), 1fr));
            gap: 1rem;
        }

        .order-card {
            background: rgba(26, 15, 8, 0.6);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(212, 160, 23, 0.08);
            border-radius: var(--radius);
            padding: 1.3rem;
            transition: all var(--transition);
            animation: cardFadeIn 0.4s cubic-bezier(0.22, 1, 0.36, 1) backwards;
        }

        @keyframes cardFadeIn {
            0% { opacity: 0; transform: translateY(16px); }
            100% { opacity: 1; transform: translateY(0); }
        }

        .order-card:hover {
            border-color: rgba(212, 160, 23, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.25), 0 0 40px rgba(212, 160, 23, 0.04);
            transform: translateY(-2px);
        }

        .order-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.8rem;
        }

        .order-id {
            font-size: 0.72rem;
            color: var(--text-dim);
            font-weight: 500;
            font-family: 'JetBrains Mono', monospace;
        }

        .order-time {
            font-size: 0.72rem;
            color: var(--text-dim);
            font-family: 'JetBrains Mono', monospace;
        }

        /* Status badges with glow */
        .order-status {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.06em;
        }

        .order-status::before {
            content: '';
            width: 5px;
            height: 5px;
            border-radius: 50%;
        }

        .status-pending {
            background: rgba(241, 196, 15, 0.1);
            color: #f1c40f;
            border: 1px solid rgba(241, 196, 15, 0.15);
        }
        .status-pending::before { background: #f1c40f; box-shadow: 0 0 6px rgba(241, 196, 15, 0.5); }

        .status-confirmed {
            background: rgba(52, 152, 219, 0.1);
            color: #3498db;
            border: 1px solid rgba(52, 152, 219, 0.15);
        }
        .status-confirmed::before { background: #3498db; box-shadow: 0 0 6px rgba(52, 152, 219, 0.5); }

        .status-preparing {
            background: rgba(230, 126, 34, 0.1);
            color: #e67e22;
            border: 1px solid rgba(230, 126, 34, 0.15);
        }
        .status-preparing::before { background: #e67e22; box-shadow: 0 0 6px rgba(230, 126, 34, 0.5); animation: statusPulse 2s infinite; }

        .status-delivered {
            background: rgba(39, 174, 96, 0.1);
            color: #27ae60;
            border: 1px solid rgba(39, 174, 96, 0.15);
        }
        .status-delivered::before { background: #27ae60; box-shadow: 0 0 6px rgba(39, 174, 96, 0.5); }

        .status-cancelled {
            background: rgba(231, 76, 60, 0.1);
            color: #e74c3c;
            border: 1px solid rgba(231, 76, 60, 0.15);
        }
        .status-cancelled::before { background: #e74c3c; }

        @keyframes statusPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }

        .order-customer {
            margin-bottom: 0.6rem;
        }

        .order-customer strong {
            color: var(--gold-light);
            font-size: 0.95rem;
            font-weight: 600;
        }

        .order-customer .phone {
            color: var(--text-muted);
            font-size: 0.8rem;
            margin-left: 0.5rem;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
        }

        .order-address {
            font-size: 0.78rem;
            color: var(--text-dim);
            margin-bottom: 0.7rem;
            line-height: 1.5;
        }

        .order-notes {
            font-size: 0.76rem;
            color: #a0896e;
            font-style: italic;
            margin-bottom: 0.7rem;
            padding: 0.45rem 0.7rem;
            background: rgba(212, 160, 23, 0.04);
            border-left: 2px solid rgba(212, 160, 23, 0.2);
            border-radius: 0 8px 8px 0;
        }

        .order-items {
            border-top: 1px solid rgba(212, 160, 23, 0.06);
            padding-top: 0.7rem;
            margin-bottom: 0.7rem;
        }

        .order-item {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            padding: 0.25rem 0;
            color: #c8b8a8;
        }

        .order-item .qty {
            color: var(--text-muted);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.72rem;
        }

        .order-item .item-price {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.78rem;
            color: var(--text-muted);
        }

        .order-total {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-top: 1px solid rgba(212, 160, 23, 0.06);
            padding-top: 0.7rem;
            margin-bottom: 0.8rem;
        }

        .order-total .amount {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--gold);
            font-family: 'JetBrains Mono', monospace;
        }

        .order-total .payment {
            font-size: 0.72rem;
            color: var(--text-muted);
            background: rgba(255, 255, 255, 0.03);
            padding: 0.25rem 0.65rem;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.04);
            text-transform: uppercase;
            letter-spacing: 0.04em;
            font-weight: 500;
        }

        .order-actions {
            display: flex;
            gap: 0.5rem;
        }

        .order-actions select {
            flex: 1;
            padding: 0.5rem 0.8rem;
            background: rgba(255, 255, 255, 0.04);
            border: 1px solid rgba(212, 160, 23, 0.1);
            border-radius: 10px;
            color: var(--cream);
            font-family: 'Poppins', sans-serif;
            font-size: 0.78rem;
            cursor: pointer;
            transition: all var(--transition);
            appearance: none;
            -webkit-appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%238a7a6a' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.7rem center;
            padding-right: 2rem;
        }

        .order-actions select:focus {
            outline: none;
            border-color: var(--gold);
            box-shadow: 0 0 0 3px rgba(212, 160, 23, 0.08);
        }

        .order-actions select option {
            background: #1a0f08;
            color: var(--cream);
        }

        /* ─── EMPTY STATE ─── */
        .empty-state {
            text-align: center;
            padding: 5rem 2rem;
            grid-column: 1 / -1;
        }

        .empty-state .icon {
            font-size: 3.5rem;
            margin-bottom: 1rem;
            filter: grayscale(0.5);
        }

        .empty-state p {
            color: var(--text-dim);
            font-size: 0.9rem;
        }

        .empty-state .sub {
            color: var(--text-faint);
            font-size: 0.78rem;
            margin-top: 0.3rem;
        }

        /* ─── RESPONSIVE ─── */
        @media (max-width: 768px) {
            .admin-header {
                flex-direction: column;
                gap: 0.7rem;
                text-align: center;
                padding: 0.8rem 1rem;
            }

            .header-left {
                justify-content: center;
            }

            .header-right {
                width: 100%;
                justify-content: center;
                flex-wrap: wrap;
                gap: 0.5rem;
            }

            .admin-stats {
                gap: 0.4rem;
                flex-wrap: wrap;
                justify-content: center;
            }

            .stat-badge {
                padding: 0.3rem 0.65rem;
                font-size: 0.72rem;
            }

            .orders-container {
                grid-template-columns: 1fr;
                padding: 0.8rem;
                gap: 0.8rem;
            }

            .filters {
                padding: 0.7rem 0.8rem;
                overflow-x: auto;
                flex-wrap: nowrap;
                -webkit-overflow-scrolling: touch;
                gap: 0.4rem;
                scrollbar-width: none;
            }
            .filters::-webkit-scrollbar { display: none; }

            .filter-btn {
                flex-shrink: 0;
                padding: 0.4rem 0.9rem;
                font-size: 0.75rem;
            }

            .order-card {
                padding: 1rem;
                border-radius: 12px;
            }

            .order-customer strong {
                font-size: 0.88rem;
            }

            .order-customer .phone {
                display: block;
                margin-left: 0;
                margin-top: 0.2rem;
            }

            .order-address { font-size: 0.75rem; }
            .order-item { font-size: 0.78rem; }
            .order-total .amount { font-size: 1rem; }
            .order-actions select { padding: 0.5rem 0.6rem; font-size: 0.75rem; }

            .login-box {
                padding: 2rem 1.5rem;
                margin: 0 0.5rem;
                max-width: 100%;
                border-radius: 16px;
            }

            .login-box h2 { font-size: 1.3rem; }

            .admin-tabs { font-size: 0.8rem; }
            .panel-header { padding: 1rem; }
            .menu-category-filters { padding: 0.5rem 0.8rem; }
            .menu-admin-grid { padding: 0 0.8rem 1rem; grid-template-columns: 1fr; }
            .specials-admin-grid { padding: 0 0.8rem 1rem; }
            .admin-modal-content { padding: 1.5rem; }
        }

        @media (max-width: 380px) {
            .stat-badge .label { display: none; }
        }

        /* Page transition */
        .dashboard-enter {
            animation: dashIn 0.5s cubic-bezier(0.22, 1, 0.36, 1);
        }
        @keyframes dashIn {
            0% { opacity: 0; }
            100% { opacity: 1; }
        }

        /* ─── THEME TOGGLE ─── */
        .theme-toggle {
            width: 38px;
            height: 38px;
            border-radius: 50%;
            border: 1px solid rgba(212, 160, 23, 0.15);
            background: rgba(255, 255, 255, 0.04);
            color: var(--gold);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition);
            flex-shrink: 0;
        }

        .theme-toggle:hover {
            background: rgba(212, 160, 23, 0.1);
            border-color: rgba(212, 160, 23, 0.3);
            transform: rotate(20deg);
        }

        .theme-toggle svg {
            width: 18px;
            height: 18px;
            transition: transform 0.4s cubic-bezier(0.22, 1, 0.36, 1);
        }

        .theme-toggle .icon-sun { display: none; }
        .theme-toggle .icon-moon { display: block; }

        /* Logout button */
        .logout-btn {
            padding: 0.35rem 0.8rem;
            border-radius: 20px;
            border: 1px solid rgba(231, 76, 60, 0.2);
            background: rgba(231, 76, 60, 0.08);
            color: #e74c3c;
            font-family: 'Poppins', sans-serif;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition);
            flex-shrink: 0;
        }

        .logout-btn:hover {
            background: rgba(231, 76, 60, 0.15);
            border-color: rgba(231, 76, 60, 0.4);
            box-shadow: 0 0 12px rgba(231, 76, 60, 0.1);
        }

        body.light-mode .logout-btn {
            background: rgba(231, 76, 60, 0.06);
            border-color: rgba(231, 76, 60, 0.15);
            color: #c0392b;
        }

        body.light-mode .logout-btn:hover {
            background: rgba(231, 76, 60, 0.12);
            border-color: rgba(231, 76, 60, 0.3);
        }

        /* ─── ADMIN TABS ─── */
        .admin-tabs {
            display: flex;
            border-bottom: 1px solid rgba(212, 160, 23, 0.12);
            background: rgba(26, 15, 8, 0.4);
        }
        .admin-tab {
            flex: 1;
            padding: 0.75rem 1rem;
            background: transparent;
            border: none;
            border-bottom: 2px solid transparent;
            color: var(--text-dim);
            font-family: 'Poppins', sans-serif;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition);
        }
        .admin-tab:hover { color: var(--text-muted); }
        .admin-tab.active {
            color: var(--gold);
            border-bottom-color: var(--gold);
            background: rgba(212, 160, 23, 0.04);
        }

        /* ─── PANEL HEADER ─── */
        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.2rem 2rem;
        }
        .panel-title {
            font-family: 'Playfair Display', serif;
            color: var(--gold);
            font-size: 1.2rem;
        }

        /* ─── MENU ADMIN GRID ─── */
        .menu-category-filters {
            padding: 0.5rem 2rem 0.8rem;
            display: flex;
            gap: 0.4rem;
            flex-wrap: wrap;
        }
        .menu-admin-grid {
            padding: 0 2rem 2rem;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(min(320px, 100%), 1fr));
            gap: 0.8rem;
        }

        /* ─── MENU ADMIN CARD ─── */
        .mac {
            background: rgba(26, 15, 8, 0.6);
            border: 1px solid rgba(212, 160, 23, 0.08);
            border-radius: var(--radius);
            padding: 1rem 1.2rem;
            transition: all var(--transition);
        }
        .mac:hover {
            border-color: rgba(212, 160, 23, 0.18);
        }
        .mac-top {
            display: flex;
            align-items: center;
            gap: 0.6rem;
            margin-bottom: 0.5rem;
        }
        .mac-type {
            width: 10px;
            height: 10px;
            border-radius: 2px;
            flex-shrink: 0;
        }
        .mac-type.veg { background: #27ae60; border: 1px solid #27ae60; }
        .mac-type.nv { background: #e74c3c; border: 1px solid #e74c3c; }
        .mac-name {
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--cream);
            flex: 1;
        }
        .mac-badge {
            font-size: 0.65rem;
            padding: 0.15rem 0.5rem;
            border-radius: 8px;
            background: rgba(212, 160, 23, 0.1);
            color: var(--gold);
            font-weight: 600;
        }
        .mac-cat {
            font-size: 0.7rem;
            color: var(--text-dim);
            margin-bottom: 0.7rem;
        }
        .mac-controls {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.8rem;
        }
        .mac-price-row {
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }
        .mac-price {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.95rem;
            font-weight: 700;
            color: var(--gold);
        }
        .mac-price-input {
            width: 70px;
            padding: 0.3rem 0.5rem;
            background: rgba(255,255,255,0.04);
            border: 1px solid rgba(212,160,23,0.2);
            border-radius: 6px;
            color: var(--cream);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
            text-align: center;
        }
        .mac-price-input:focus {
            outline: none;
            border-color: var(--gold);
            box-shadow: 0 0 0 3px rgba(212,160,23,0.08);
        }
        .mac-edit-btn, .mac-save-btn {
            background: none;
            border: 1px solid rgba(212,160,23,0.15);
            border-radius: 6px;
            padding: 0.25rem 0.5rem;
            font-size: 0.7rem;
            color: var(--text-muted);
            cursor: pointer;
            transition: all var(--transition);
            font-family: 'Poppins', sans-serif;
        }
        .mac-edit-btn:hover { border-color: var(--gold); color: var(--gold); }
        .mac-save-btn {
            background: rgba(39,174,96,0.1);
            border-color: rgba(39,174,96,0.2);
            color: #27ae60;
        }
        .mac-save-btn:hover { background: rgba(39,174,96,0.2); }

        .mac-remove-btn {
            background: none;
            border: 1px solid rgba(231, 76, 60, 0.15);
            border-radius: 6px;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            color: var(--text-dim);
            cursor: pointer;
            transition: all var(--transition);
            flex-shrink: 0;
        }
        .mac-remove-btn:hover {
            background: rgba(231, 76, 60, 0.12);
            border-color: rgba(231, 76, 60, 0.4);
            color: #e74c3c;
        }

        /* ─── MENU IMAGE UPLOAD ─── */
        .mac-image-section {
            margin: 0.6rem 0;
            border-top: 1px solid rgba(212, 160, 23, 0.06);
            padding-top: 0.6rem;
        }
        .mac-img-preview {
            width: 100%;
            max-height: 120px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            border: 1px solid rgba(212, 160, 23, 0.12);
        }
        .mac-img-controls {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            flex-wrap: wrap;
        }
        .mac-img-upload-btn {
            background: rgba(212, 160, 23, 0.08);
            border: 1px solid rgba(212, 160, 23, 0.18);
            border-radius: 6px;
            padding: 0.25rem 0.6rem;
            font-size: 0.7rem;
            color: var(--gold);
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: 'Poppins', sans-serif;
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
        }
        .mac-img-upload-btn:hover {
            background: rgba(212, 160, 23, 0.15);
            border-color: var(--gold);
        }
        .mac-img-remove-btn {
            background: none;
            border: 1px solid rgba(231, 76, 60, 0.15);
            border-radius: 6px;
            padding: 0.25rem 0.5rem;
            font-size: 0.65rem;
            color: var(--text-dim);
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: 'Poppins', sans-serif;
        }
        .mac-img-remove-btn:hover {
            background: rgba(231, 76, 60, 0.1);
            border-color: rgba(231, 76, 60, 0.4);
            color: #e74c3c;
        }
        .mac-img-status {
            font-size: 0.65rem;
            color: var(--gold);
            font-style: italic;
        }

        /* ─── SLIDESHOW ADMIN ─── */
        .slides-admin-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 1rem;
        }
        .sc {
            background: var(--card-bg);
            border: 1px solid rgba(212, 160, 23, 0.08);
            border-radius: 10px;
            overflow: hidden;
            transition: all 0.2s ease;
        }
        .sc:hover { border-color: rgba(212, 160, 23, 0.2); }
        .sc-inactive { opacity: 0.45; filter: grayscale(0.3); }
        .sc-preview {
            width: 100%;
            height: 140px;
            object-fit: cover;
            display: block;
            background: rgba(0,0,0,0.3);
        }
        .sc-info {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.5rem 0.7rem;
        }
        .sc-type-badge {
            font-size: 0.6rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            padding: 0.15rem 0.45rem;
            border-radius: 4px;
        }
        .sc-type-badge.image {
            background: rgba(212, 160, 23, 0.12);
            color: var(--gold);
        }
        .sc-type-badge.video {
            background: rgba(139, 26, 26, 0.12);
            color: #e74c3c;
        }
        .sc-order {
            font-size: 0.7rem;
            color: var(--text-dim);
        }
        .sc-controls {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.4rem 0.7rem 0.6rem;
            border-top: 1px solid rgba(212, 160, 23, 0.06);
        }
        .sc-move-btn {
            background: none;
            border: 1px solid rgba(212, 160, 23, 0.12);
            border-radius: 5px;
            padding: 0.15rem 0.4rem;
            font-size: 0.6rem;
            color: var(--text-dim);
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: 'Poppins', sans-serif;
        }
        .sc-move-btn:hover:not(:disabled) { border-color: var(--gold); color: var(--gold); }
        .sc-move-btn:disabled { opacity: 0.3; cursor: default; }
        .sc-remove-btn {
            background: none;
            border: 1px solid rgba(231, 76, 60, 0.12);
            border-radius: 5px;
            padding: 0.15rem 0.4rem;
            font-size: 0.65rem;
            color: var(--text-dim);
            cursor: pointer;
            transition: all 0.2s ease;
            margin-left: auto;
            font-family: 'Poppins', sans-serif;
        }
        .sc-remove-btn:hover { border-color: rgba(231, 76, 60, 0.4); color: #e74c3c; }
        .slide-upload-btn {
            background: rgba(212, 160, 23, 0.08);
            border: 1px solid rgba(212, 160, 23, 0.18);
            border-radius: 8px;
            padding: 0.4rem 1rem;
            font-size: 0.75rem;
            color: var(--gold);
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: 'Poppins', sans-serif;
            font-weight: 600;
        }
        .slide-upload-btn:hover { background: rgba(212, 160, 23, 0.15); border-color: var(--gold); }
        .slide-upload-status {
            font-size: 0.7rem;
            color: var(--gold);
            font-style: italic;
            padding: 0 0 0.5rem;
            min-height: 1.2em;
        }

        /* Light mode overrides */
        body.light-mode .sc { border-color: rgba(0,0,0,0.06); }
        body.light-mode .sc-type-badge.image { background: rgba(139,26,26,0.06); color: var(--primary); }
        body.light-mode .sc-type-badge.video { background: rgba(231,76,60,0.06); }
        body.light-mode .slide-upload-btn { background: rgba(139,26,26,0.05); border-color: rgba(139,26,26,0.15); color: var(--primary); }
        body.light-mode .slide-upload-status { color: var(--primary); }

        /* ─── TOGGLE SWITCH ─── */
        .toggle-switch {
            position: relative;
            width: 42px;
            height: 22px;
            display: inline-block;
            flex-shrink: 0;
        }
        .toggle-switch input { opacity: 0; width: 0; height: 0; position: absolute; }
        .toggle-slider {
            position: absolute;
            inset: 0;
            background: rgba(231, 76, 60, 0.25);
            border: 1px solid rgba(231, 76, 60, 0.2);
            border-radius: 11px;
            cursor: pointer;
            transition: all var(--transition);
        }
        .toggle-slider::before {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            left: 2px;
            top: 2px;
            background: #e74c3c;
            border-radius: 50%;
            transition: all var(--transition);
        }
        .toggle-switch input:checked + .toggle-slider {
            background: rgba(39, 174, 96, 0.2);
            border-color: rgba(39, 174, 96, 0.3);
        }
        .toggle-switch input:checked + .toggle-slider::before {
            transform: translateX(20px);
            background: #27ae60;
        }
        .mac-unavailable .mac-name {
            text-decoration: line-through;
            opacity: 0.5;
        }

        /* ─── SPECIALS ADMIN CARD ─── */
        .sac {
            background: rgba(26, 15, 8, 0.6);
            border: 1px solid rgba(212, 160, 23, 0.12);
            border-radius: var(--radius);
            padding: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
            transition: all var(--transition);
        }
        .sac:hover { border-color: rgba(212, 160, 23, 0.2); }
        .sac-info { flex: 1; }
        .sac-name {
            font-weight: 600;
            font-size: 0.95rem;
            color: var(--cream);
        }
        .sac-meta {
            font-size: 0.75rem;
            color: var(--text-dim);
            margin-top: 0.2rem;
        }
        .sac-price {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 700;
            color: var(--gold);
            font-size: 1rem;
        }
        .sac-badge {
            font-size: 0.65rem;
            padding: 0.15rem 0.5rem;
            border-radius: 8px;
            background: rgba(212, 160, 23, 0.1);
            color: var(--gold);
            font-weight: 600;
            margin-left: 0.5rem;
        }
        .sac-actions {
            display: flex;
            align-items: center;
            gap: 0.6rem;
        }
        .sac-remove {
            background: rgba(231, 76, 60, 0.1);
            border: 1px solid rgba(231, 76, 60, 0.2);
            color: #e74c3c;
            border-radius: 8px;
            padding: 0.4rem 0.8rem;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all var(--transition);
            font-family: 'Poppins', sans-serif;
        }
        .sac-remove:hover { background: rgba(231, 76, 60, 0.2); }

        /* ─── ADD SPECIAL BUTTON & MODAL ─── */
        .add-special-btn {
            background: rgba(212, 160, 23, 0.1);
            border: 1px solid rgba(212, 160, 23, 0.2);
            color: var(--gold);
            border-radius: 10px;
            padding: 0.5rem 1rem;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition);
            font-family: 'Poppins', sans-serif;
        }
        .add-special-btn:hover { background: rgba(212, 160, 23, 0.15); border-color: var(--gold); }

        .admin-modal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            z-index: 200;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }
        .admin-modal-content {
            background: var(--dark-card);
            border: 1px solid rgba(212,160,23,0.15);
            border-radius: 16px;
            padding: 2rem;
            max-width: 420px;
            width: 100%;
            box-shadow: 0 16px 60px rgba(0,0,0,0.5);
        }
        .admin-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        .admin-modal-header h3 {
            font-family: 'Playfair Display', serif;
            color: var(--gold);
            font-size: 1.1rem;
        }
        .modal-close {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 1.5rem;
            cursor: pointer;
            line-height: 1;
        }
        .admin-modal-content select,
        .admin-modal-content input,
        .admin-modal-content textarea {
            width: 100%;
            padding: 0.7rem 0.9rem;
            background: rgba(255,255,255,0.04);
            border: 1px solid rgba(212,160,23,0.12);
            border-radius: 10px;
            color: var(--cream);
            font-family: 'Poppins', sans-serif;
            font-size: 0.85rem;
            margin-bottom: 0.8rem;
            transition: all var(--transition);
        }
        .admin-modal-content select:focus,
        .admin-modal-content input:focus,
        .admin-modal-content textarea:focus {
            outline: none;
            border-color: var(--gold);
            box-shadow: 0 0 0 3px rgba(212,160,23,0.08);
        }
        .admin-modal-content select option {
            background: var(--dark-card);
            color: var(--cream);
        }
        .add-special-confirm {
            width: 100%;
            padding: 0.75rem;
            background: linear-gradient(135deg, var(--gold), var(--gold-dark));
            color: var(--dark-card);
            border: none;
            border-radius: 10px;
            font-family: 'Poppins', sans-serif;
            font-size: 0.9rem;
            font-weight: 700;
            cursor: pointer;
            transition: all var(--transition);
            margin-top: 0.5rem;
        }
        .add-special-confirm:hover { box-shadow: 0 4px 16px rgba(212,160,23,0.3); }

        .specials-admin-grid {
            padding: 0 2rem 2rem;
            display: grid;
            gap: 0.8rem;
        }

        /* ─── LIGHT MODE ─── */
        body.light-mode {
            background: #faf7f2;
            color: #2c1810;
        }

        body.light-mode::before {
            opacity: 0.015;
        }

        /* Scrollbar */
        body.light-mode ::-webkit-scrollbar-track { background: #f0ebe4; }
        body.light-mode ::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, var(--primary), var(--gold-dark));
        }

        /* Login */
        body.light-mode .admin-login {
            background: linear-gradient(145deg, #faf7f2, #f0ebe4);
        }

        body.light-mode .admin-login::before {
            background: radial-gradient(ellipse, rgba(139, 26, 26, 0.06) 0%, transparent 70%);
        }

        body.light-mode .login-box {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(24px);
            -webkit-backdrop-filter: blur(24px);
            border-color: rgba(139, 26, 26, 0.1);
            box-shadow: 0 8px 40px rgba(0, 0, 0, 0.08), 0 0 0 1px rgba(139, 26, 26, 0.05);
        }

        body.light-mode .login-box h2 {
            color: var(--primary);
        }

        body.light-mode .login-box p {
            color: #6b5b4b;
        }

        body.light-mode .login-box input {
            background: rgba(0, 0, 0, 0.02);
            border-color: rgba(139, 26, 26, 0.12);
            color: #2c1810;
        }

        body.light-mode .login-box input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(139, 26, 26, 0.08), 0 0 20px rgba(139, 26, 26, 0.05);
            background: #fff;
        }

        body.light-mode .login-box input::placeholder {
            color: #a09080;
        }

        body.light-mode .login-btn {
            background: linear-gradient(135deg, var(--primary), #a52a2a);
            color: #fff;
        }

        body.light-mode .login-btn::after {
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.25), transparent);
        }

        body.light-mode .login-btn:hover {
            box-shadow: 0 6px 24px rgba(139, 26, 26, 0.3);
        }

        /* Header */
        body.light-mode .admin-header {
            background: linear-gradient(135deg, rgba(255, 252, 245, 0.95), rgba(250, 247, 242, 0.95));
            border-bottom-color: rgba(139, 26, 26, 0.08);
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.06);
        }

        body.light-mode .admin-header h1 {
            color: var(--primary);
        }

        body.light-mode .admin-header h1 span {
            color: #2c1810;
        }

        body.light-mode .stat-badge {
            background: rgba(139, 26, 26, 0.04);
            border-color: rgba(139, 26, 26, 0.1);
            color: #6b5b4b;
        }

        body.light-mode .stat-badge:hover {
            background: rgba(139, 26, 26, 0.08);
            border-color: rgba(139, 26, 26, 0.18);
        }

        body.light-mode .stat-badge .num {
            color: var(--primary);
        }

        body.light-mode .live-label {
            background: rgba(39, 174, 96, 0.06);
            border-color: rgba(39, 174, 96, 0.12);
        }

        /* Theme toggle in light mode */
        body.light-mode .theme-toggle {
            background: rgba(139, 26, 26, 0.04);
            border-color: rgba(139, 26, 26, 0.12);
            color: var(--primary);
        }

        body.light-mode .theme-toggle:hover {
            background: rgba(139, 26, 26, 0.08);
            border-color: rgba(139, 26, 26, 0.2);
        }

        body.light-mode .theme-toggle .icon-sun { display: block; }
        body.light-mode .theme-toggle .icon-moon { display: none; }

        /* Filters */
        body.light-mode .filters {
            border-bottom-color: rgba(0, 0, 0, 0.06);
        }

        body.light-mode .filter-btn {
            background: rgba(0, 0, 0, 0.02);
            border-color: rgba(0, 0, 0, 0.08);
            color: #6b5b4b;
        }

        body.light-mode .filter-btn:hover {
            background: rgba(139, 26, 26, 0.05);
            color: #4a3a2a;
            border-color: rgba(139, 26, 26, 0.15);
        }

        body.light-mode .filter-btn.active {
            background: rgba(139, 26, 26, 0.08);
            border-color: var(--primary);
            color: var(--primary);
            box-shadow: 0 0 12px rgba(139, 26, 26, 0.08);
        }

        /* Order cards */
        body.light-mode .order-card {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-color: rgba(0, 0, 0, 0.06);
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.04);
        }

        body.light-mode .order-card:hover {
            border-color: rgba(139, 26, 26, 0.15);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08), 0 0 0 1px rgba(139, 26, 26, 0.05);
        }

        body.light-mode .order-id,
        body.light-mode .order-time {
            color: #8a7a6a;
        }

        body.light-mode .order-customer strong {
            color: #2c1810;
        }

        body.light-mode .order-customer .phone {
            color: #6b5b4b;
        }

        body.light-mode .order-address {
            color: #7a6a5a;
        }

        body.light-mode .order-notes {
            color: #6b5b4b;
            background: rgba(139, 26, 26, 0.03);
            border-left-color: rgba(139, 26, 26, 0.2);
        }

        body.light-mode .order-items {
            border-top-color: rgba(0, 0, 0, 0.06);
        }

        body.light-mode .order-item {
            color: #4a3a2a;
        }

        body.light-mode .order-item .qty,
        body.light-mode .order-item .item-price {
            color: #6b5b4b;
        }

        body.light-mode .order-total {
            border-top-color: rgba(0, 0, 0, 0.06);
        }

        body.light-mode .order-total .amount {
            color: var(--primary);
        }

        body.light-mode .order-total .payment {
            color: #6b5b4b;
            background: rgba(0, 0, 0, 0.03);
            border-color: rgba(0, 0, 0, 0.06);
        }

        /* Status badges — keep the colors, just tweak backgrounds for readability */
        body.light-mode .status-pending {
            background: rgba(241, 196, 15, 0.1);
            color: #b8940a;
        }

        body.light-mode .status-confirmed {
            background: rgba(52, 152, 219, 0.08);
            color: #2579a8;
        }

        body.light-mode .status-preparing {
            background: rgba(230, 126, 34, 0.08);
            color: #c06a1e;
        }

        body.light-mode .status-delivered {
            background: rgba(39, 174, 96, 0.08);
            color: #1d8e4e;
        }

        body.light-mode .status-cancelled {
            background: rgba(231, 76, 60, 0.08);
            color: #c0392b;
        }

        /* Actions select */
        body.light-mode .order-actions select {
            background-color: rgba(0, 0, 0, 0.02);
            border-color: rgba(0, 0, 0, 0.1);
            color: #2c1810;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%236b5b4b' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'/%3E%3C/svg%3E");
        }

        body.light-mode .order-actions select:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(139, 26, 26, 0.06);
        }

        body.light-mode .order-actions select option {
            background: #fff;
            color: #2c1810;
        }

        /* Empty state */
        body.light-mode .empty-state p {
            color: #6b5b4b;
        }

        body.light-mode .empty-state .sub {
            color: #8a7a6a;
        }

        /* ─── LIGHT MODE: Admin Tabs, Menu, Specials ─── */
        body.light-mode .admin-tabs {
            background: rgba(0,0,0,0.02);
            border-bottom-color: rgba(0,0,0,0.08);
        }
        body.light-mode .admin-tab {
            color: #6b5b4b;
        }
        body.light-mode .admin-tab:hover { color: #4a3a2a; }
        body.light-mode .admin-tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
            background: rgba(139,26,26,0.04);
        }
        body.light-mode .panel-title { color: var(--primary); }
        body.light-mode .mac {
            background: rgba(255,255,255,0.8);
            border-color: rgba(0,0,0,0.06);
        }
        body.light-mode .mac:hover { border-color: rgba(139,26,26,0.15); }
        body.light-mode .mac-name { color: #2c1810; }
        body.light-mode .mac-badge {
            background: rgba(139,26,26,0.06);
            color: var(--primary);
        }
        body.light-mode .mac-cat { color: #8a7a6a; }
        body.light-mode .mac-img-preview { border-color: rgba(0,0,0,0.08); }
        body.light-mode .mac-img-upload-btn { background: rgba(139,26,26,0.05); border-color: rgba(139,26,26,0.15); color: var(--primary); }
        body.light-mode .mac-img-upload-btn:hover { background: rgba(139,26,26,0.1); border-color: var(--primary); }
        body.light-mode .mac-img-remove-btn { color: #8a7a6a; border-color: rgba(0,0,0,0.08); }
        body.light-mode .mac-img-status { color: var(--primary); }
        body.light-mode .mac-price { color: var(--primary); }
        body.light-mode .mac-price-input {
            background: rgba(0,0,0,0.02);
            border-color: rgba(139,26,26,0.15);
            color: #2c1810;
        }
        body.light-mode .mac-edit-btn { color: #6b5b4b; border-color: rgba(0,0,0,0.1); }
        body.light-mode .mac-edit-btn:hover { color: var(--primary); border-color: var(--primary); }
        body.light-mode .mac-remove-btn { color: #8a7a6a; border-color: rgba(0,0,0,0.08); }
        body.light-mode .mac-remove-btn:hover { color: #c0392b; border-color: rgba(231,76,60,0.3); background: rgba(231,76,60,0.06); }
        body.light-mode .sac {
            background: rgba(255,255,255,0.8);
            border-color: rgba(0,0,0,0.06);
        }
        body.light-mode .sac-name { color: #2c1810; }
        body.light-mode .sac-price { color: var(--primary); }
        body.light-mode .sac-badge {
            background: rgba(139,26,26,0.06);
            color: var(--primary);
        }
        body.light-mode .add-special-btn {
            background: rgba(139,26,26,0.06);
            border-color: rgba(139,26,26,0.15);
            color: var(--primary);
        }
        body.light-mode .admin-modal-content {
            background: #faf7f2;
            border-color: rgba(139,26,26,0.1);
        }
        body.light-mode .admin-modal-content select,
        body.light-mode .admin-modal-content input,
        body.light-mode .admin-modal-content textarea {
            background: rgba(0,0,0,0.02);
            border-color: rgba(0,0,0,0.1);
            color: #2c1810;
        }
        body.light-mode .admin-modal-content select option {
            background: #fff;
            color: #2c1810;
        }
        body.light-mode .add-special-confirm {
            background: linear-gradient(135deg, var(--primary), #a52a2a);
            color: #fff;
        }

        /* ─── EXPORT CSV BUTTON ─── */
        .export-btn { background: rgba(212,160,23,0.15) !important; color: var(--gold) !important; border: 1px solid rgba(212,160,23,0.2) !important; margin-left: auto; }
        .export-btn:hover { background: rgba(212,160,23,0.25) !important; }

        /* ─── ORDER PRINT + WHATSAPP ─── */
        .order-print-btn { background: rgba(212,160,23,0.1); color: var(--gold); border: 1px solid rgba(212,160,23,0.15); border-radius: 8px; padding: 0.3rem 0.7rem; font-size: 0.7rem; cursor: pointer; transition: all 0.2s; }
        .order-print-btn:hover { background: rgba(212,160,23,0.2); }
        .wa-update-btn { display: inline-flex; align-items: center; background: rgba(37,211,102,0.12); color: #25d366; border: 1px solid rgba(37,211,102,0.2); border-radius: 8px; padding: 0.3rem 0.7rem; font-size: 0.7rem; text-decoration: none; cursor: pointer; transition: all 0.2s; }
        .wa-update-btn:hover { background: rgba(37,211,102,0.25); }
        .order-actions { display: flex; gap: 0.4rem; align-items: center; flex-wrap: wrap; }

        /* ─── STOCK / INVENTORY ─── */
        .mac-stock-row { display: flex; align-items: center; gap: 0.4rem; padding-top: 0.5rem; margin-top: 0.5rem; border-top: 1px solid rgba(212,160,23,0.06); flex-wrap: wrap; }
        .stock-label { font-size: 0.7rem; color: var(--text-muted); }
        .stock-input { width: 60px; padding: 0.25rem 0.4rem; background: rgba(255,255,255,0.03); border: 1px solid rgba(212,160,23,0.1); border-radius: 6px; color: var(--gold); font-size: 0.75rem; text-align: center; }
        .stock-input:focus { outline: none; border-color: rgba(212,160,23,0.3); }
        .stock-save-btn { padding: 0.25rem 0.6rem; background: rgba(212,160,23,0.1); color: var(--gold); border: 1px solid rgba(212,160,23,0.15); border-radius: 6px; font-size: 0.7rem; cursor: pointer; }
        .stock-save-btn:hover { background: rgba(212,160,23,0.2); }
        .stock-badge { font-size: 0.65rem; padding: 0.15rem 0.5rem; border-radius: 8px; font-weight: 600; margin-left: auto; }
        .stock-ok { background: rgba(39,174,96,0.1); color: #27ae60; border: 1px solid rgba(39,174,96,0.2); }
        .stock-low { background: rgba(241,196,15,0.1); color: #f1c40f; border: 1px solid rgba(241,196,15,0.2); }
        .stock-out { background: rgba(231,76,60,0.1); color: #e74c3c; border: 1px solid rgba(231,76,60,0.2); }

        /* ─── ANALYTICS ─── */
        .analytics-summary { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 0.8rem; margin-bottom: 1.2rem; }
        .an-card { background: rgba(26,15,8,0.6); border: 1px solid rgba(212,160,23,0.08); border-radius: var(--radius); padding: 1rem 1.2rem; text-align: center; }
        .an-val { font-size: 1.5rem; font-weight: 700; color: var(--gold); line-height: 1.2; }
        .an-val small { font-size: 0.7rem; color: var(--text-muted); font-weight: 400; }
        .an-label { font-size: 0.72rem; color: var(--text-muted); margin-top: 0.2rem; }
        .analytics-charts { display: grid; grid-template-columns: repeat(auto-fill, minmax(min(400px,100%), 1fr)); gap: 1rem; margin-bottom: 1rem; }
        .chart-box { background: rgba(26,15,8,0.5); border: 1px solid rgba(212,160,23,0.06); border-radius: var(--radius); padding: 1rem; }
        .chart-box h3 { font-size: 0.82rem; color: var(--gold); margin-bottom: 0.8rem; font-weight: 500; }
        .chart-box canvas { width: 100% !important; }

        /* Top items */
        .top-item { display: flex; align-items: center; gap: 0.5rem; padding: 0.35rem 0; border-bottom: 1px solid rgba(212,160,23,0.04); }
        .top-rank { font-size: 0.7rem; color: var(--gold); font-weight: 700; min-width: 26px; }
        .top-name { font-size: 0.75rem; color: var(--cream); flex: 1; min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .top-bar { flex: 0 0 60px; height: 6px; background: rgba(212,160,23,0.08); border-radius: 3px; overflow: hidden; }
        .top-bar-fill { height: 100%; background: linear-gradient(90deg, var(--gold), var(--gold-light)); border-radius: 3px; }
        .top-qty { font-size: 0.65rem; color: var(--text-muted); min-width: 50px; text-align: right; }
        .top-rev { font-size: 0.65rem; color: var(--gold-dark); min-width: 50px; text-align: right; }

        /* Peak hours */
        .peak-grid { display: grid; grid-template-columns: repeat(12, 1fr); gap: 3px; }
        .peak-cell { text-align: center; padding: 0.4rem 0.2rem; border-radius: 6px; border: 1px solid rgba(212,160,23,0.04); }
        .peak-h { display: block; font-size: 0.6rem; color: var(--text-dim); }
        .peak-c { display: block; font-size: 0.75rem; font-weight: 600; color: var(--gold); }

        /* Status breakdown */
        .sb-row { display: flex; align-items: center; gap: 0.5rem; padding: 0.3rem 0; }
        .sb-label { font-size: 0.72rem; min-width: 70px; text-transform: capitalize; }
        .sb-bar { flex: 1; height: 8px; background: rgba(255,255,255,0.03); border-radius: 4px; overflow: hidden; }
        .sb-fill { height: 100%; border-radius: 4px; transition: width 0.5s; }
        .status-bg-pending { background: #f1c40f; } .status-bg-confirmed { background: #3498db; }
        .status-bg-preparing { background: #e67e22; } .status-bg-delivered { background: #27ae60; }
        .status-bg-cancelled { background: #e74c3c; }
        .sb-val { font-size: 0.68rem; color: var(--text-muted); min-width: 60px; text-align: right; }

        /* ─── COUPONS ─── */
        .coupons-admin-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(min(300px,100%), 1fr)); gap: 0.8rem; }
        .coupon-card { background: rgba(26,15,8,0.6); border: 1px solid rgba(212,160,23,0.08); border-radius: var(--radius); padding: 1rem; position: relative; }
        .coupon-card:hover { border-color: rgba(212,160,23,0.2); }
        .coupon-expired { opacity: 0.5; }
        .coupon-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; }
        .coupon-code { font-family: monospace; font-size: 1.1rem; font-weight: 700; color: var(--gold); letter-spacing: 0.08em; background: rgba(212,160,23,0.08); padding: 0.2rem 0.6rem; border-radius: 6px; }
        .coupon-details { margin-bottom: 0.4rem; }
        .coupon-discount { font-size: 0.85rem; color: var(--cream); font-weight: 600; margin-right: 0.5rem; }
        .coupon-label { font-size: 0.72rem; color: var(--text-muted); }
        .coupon-meta { display: flex; flex-wrap: wrap; gap: 0.5rem; }
        .coupon-meta span { font-size: 0.65rem; color: var(--text-dim); background: rgba(255,255,255,0.03); padding: 0.15rem 0.5rem; border-radius: 6px; }
        .coupon-card .mac-remove-btn { position: absolute; top: 0.5rem; right: 0.5rem; }

        /* ─── REVIEWS ADMIN ─── */
        .review-summary { margin-bottom: 1rem; }
        .rv-stat { display: flex; align-items: center; gap: 0.8rem; background: rgba(26,15,8,0.5); border: 1px solid rgba(212,160,23,0.08); border-radius: var(--radius); padding: 1rem 1.5rem; }
        .rv-big { font-size: 2rem; font-weight: 700; color: var(--gold); }
        .rv-stars { font-size: 1.1rem; }
        .star-full { color: var(--gold); }
        .star-half { color: var(--gold); opacity: 0.5; }
        .star-empty { color: var(--text-faint); }
        .rv-count { font-size: 0.75rem; color: var(--text-muted); }
        .reviews-admin-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(min(300px,100%), 1fr)); gap: 0.8rem; }
        .rv-card { background: rgba(26,15,8,0.6); border: 1px solid rgba(212,160,23,0.06); border-radius: var(--radius); padding: 1rem; }
        .rv-card:hover { border-color: rgba(212,160,23,0.15); }
        .rv-top { display: flex; justify-content: space-between; margin-bottom: 0.3rem; }
        .rv-item { font-size: 0.82rem; font-weight: 600; color: var(--cream); }
        .rv-date { font-size: 0.68rem; color: var(--text-dim); }
        .rv-rating { margin-bottom: 0.3rem; }
        .rv-rating span { font-size: 0.72rem; color: var(--text-muted); margin-left: 0.3rem; }
        .rv-text { font-size: 0.78rem; color: var(--text-muted); font-style: italic; margin-bottom: 0.3rem; line-height: 1.4; }
        .rv-author { font-size: 0.7rem; color: var(--text-dim); }

        /* ─── CRM ─── */
        .crm-summary { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 0.8rem; margin-bottom: 1rem; }
        .crm-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(min(340px,100%), 1fr)); gap: 0.8rem; }
        .crm-card { background: rgba(26,15,8,0.6); border: 1px solid rgba(212,160,23,0.08); border-radius: var(--radius); padding: 1rem; cursor: pointer; transition: all var(--transition); }
        .crm-card:hover { border-color: rgba(212,160,23,0.2); transform: translateY(-1px); }
        .crm-top { display: flex; align-items: center; gap: 0.7rem; margin-bottom: 0.5rem; }
        .crm-avatar { width: 36px; height: 36px; border-radius: 50%; background: linear-gradient(135deg, var(--gold), var(--gold-dark)); display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.9rem; color: #1a0f08; flex-shrink: 0; }
        .crm-info { flex: 1; min-width: 0; }
        .crm-name { display: block; font-size: 0.82rem; font-weight: 600; color: var(--cream); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .crm-phone { display: block; font-size: 0.68rem; color: var(--text-dim); }
        .crm-tier { font-size: 0.7rem; font-weight: 600; white-space: nowrap; }
        .crm-stats { display: flex; flex-wrap: wrap; gap: 0.5rem; }
        .crm-stats span { font-size: 0.68rem; color: var(--text-muted); background: rgba(255,255,255,0.03); padding: 0.2rem 0.5rem; border-radius: 6px; }
        .crm-detail { margin-top: 0.8rem; border-top: 1px solid rgba(212,160,23,0.06); padding-top: 0.6rem; }
        .crm-no-orders { font-size: 0.72rem; color: var(--text-dim); font-style: italic; }
        .crm-orders { display: flex; flex-direction: column; gap: 0.3rem; }
        .crm-order-row { display: flex; align-items: center; gap: 0.5rem; font-size: 0.68rem; padding: 0.3rem 0; border-bottom: 1px solid rgba(212,160,23,0.03); }
        .crm-order-date { color: var(--text-dim); min-width: 50px; }
        .crm-order-items { flex: 1; color: var(--text-muted); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .crm-order-total { color: var(--gold); font-weight: 600; min-width: 50px; text-align: right; }

        /* ─── ADMIN TABS SCROLL ─── */
        .admin-tabs { overflow-x: auto; white-space: nowrap; -webkit-overflow-scrolling: touch; scrollbar-width: none; }
        .admin-tabs::-webkit-scrollbar { display: none; }
        .admin-tab { flex-shrink: 0; }

        /* ─── LIGHT MODE OVERRIDES ─── */
        body.light-mode .an-card, body.light-mode .chart-box, body.light-mode .coupon-card, body.light-mode .rv-card, body.light-mode .rv-stat, body.light-mode .crm-card {
            background: rgba(255,255,255,0.8); border-color: rgba(0,0,0,0.06);
        }
        body.light-mode .an-val { color: var(--primary); }
        body.light-mode .coupon-code { background: rgba(139,26,26,0.08); color: var(--primary); }
        body.light-mode .stock-input { background: rgba(0,0,0,0.03); color: var(--primary); border-color: rgba(0,0,0,0.1); }
        body.light-mode .peak-cell { border-color: rgba(0,0,0,0.04); }
        body.light-mode .crm-avatar { color: #fff; }
        body.light-mode .wa-update-btn { background: rgba(37,211,102,0.08); }
        body.light-mode .export-btn { background: rgba(139,26,26,0.08) !important; color: var(--primary) !important; border-color: rgba(139,26,26,0.15) !important; }

        /* ─── EXPENSES LIGHT MODE ─── */
        body.light-mode .expenses-summary-strip { background: rgba(139,26,26,0.05); border-color: rgba(139,26,26,0.12); }
        body.light-mode .expenses-summary-strip .exp-total { color: var(--primary); }
        body.light-mode .expenses-summary-strip .exp-breakdown span strong { color: #2c1810; }
        body.light-mode .expenses-summary-strip .exp-breakdown { color: #6b5b4b; }
        body.light-mode .expense-card { background: rgba(255,255,255,0.8); border-color: rgba(0,0,0,0.06); border-left-color: var(--primary); }
        body.light-mode .expense-card:hover { border-color: rgba(139,26,26,0.25); border-left-color: var(--primary); }
        body.light-mode .expense-card .exp-date { color: #6b5b4b; }
        body.light-mode .expense-card .exp-amount { color: var(--primary); }
        body.light-mode .expense-card .exp-desc { color: #2c1810; }
        body.light-mode .exp-paid-by { color: #6b5b4b !important; }
        body.light-mode .exp-paid-by strong { color: #2c1810 !important; }
        body.light-mode .exp-table-wrap { border-color: rgba(0,0,0,0.08); }
        body.light-mode .exp-table th { background: rgba(139,26,26,0.06); color: var(--primary); border-bottom-color: rgba(139,26,26,0.15); }
        body.light-mode .exp-table td { color: #2c1810; border-bottom-color: rgba(0,0,0,0.06); }
        body.light-mode .exp-table tr:hover td { background: rgba(139,26,26,0.03); }
        body.light-mode .exp-table .exp-amount-cell { color: var(--primary); }
        body.light-mode .exp-table .exp-date-cell { color: #6b5b4b; }
        body.light-mode .exp-table .exp-desc-cell { color: #4a3a2a; }
        body.light-mode .exp-table tfoot td { border-top-color: rgba(139,26,26,0.2); background: rgba(139,26,26,0.04); color: var(--primary); }
        body.light-mode .exp-view-toggle { border-color: rgba(139,26,26,0.2); }
        body.light-mode .exp-view-toggle button { color: #6b5b4b; }
        body.light-mode .exp-view-toggle button.active { background: var(--primary); color: #fff; }
        body.light-mode .exp-view-toggle button:hover:not(.active) { background: rgba(139,26,26,0.06); color: #2c1810; }
        body.light-mode .exp-download-btn { color: var(--primary); border-color: rgba(139,26,26,0.2); }
        body.light-mode .exp-download-btn:hover { background: rgba(139,26,26,0.08); border-color: var(--primary); }
        body.light-mode .expenses-filter-bar input[type="month"],
        body.light-mode .expenses-filter-bar input[type="date"] { background: rgba(0,0,0,0.03); border-color: rgba(0,0,0,0.1); color: #2c1810; }
        body.light-mode .expense-modal-box { background: #faf7f2; border-color: rgba(139,26,26,0.15); }
        body.light-mode .expense-modal-box h3 { color: var(--primary); }
        body.light-mode .exp-form-row label { color: #6b5b4b; }
        body.light-mode .exp-form-row input, body.light-mode .exp-form-row select, body.light-mode .exp-form-row textarea { background: rgba(0,0,0,0.03); border-color: rgba(0,0,0,0.1); color: #2c1810; }
        body.light-mode .exp-form-row select option { background: #fff; }
        body.light-mode .exp-save-btn { background: var(--primary); color: #fff; }
        body.light-mode .exp-cancel-btn { color: #6b5b4b; border-color: rgba(0,0,0,0.12); }
        body.light-mode .exp-bill-upload-area { border-color: rgba(139,26,26,0.2); }
        body.light-mode .exp-bill-upload-area:hover { border-color: var(--primary); background: rgba(139,26,26,0.03); }
        body.light-mode .exp-scan-btn { background: rgba(139,26,26,0.08); border-color: rgba(139,26,26,0.2); color: var(--primary); }
        body.light-mode .exp-scan-btn:hover { background: rgba(139,26,26,0.14); border-color: var(--primary); }
        body.light-mode .filter-btn { color: #6b5b4b; }

        /* ─── THEME SELECTOR ─── */
        .theme-selector { background: rgba(212,160,23,0.08); border: 1px solid rgba(212,160,23,0.15); border-radius: 8px; color: var(--gold); padding: 0.3rem 0.5rem; font-size: 0.72rem; cursor: pointer; }
        .theme-selector option { background: var(--dark-card); color: var(--cream); }
        body.light-mode .theme-selector { background: rgba(0,0,0,0.04); color: var(--primary); border-color: rgba(0,0,0,0.1); }
        body.light-mode .theme-selector option { background: #fff; color: #2c1810; }

        /* ─── GIFT CARD AMOUNT BUTTONS (mirror in customer portal) ─── */
        .gc-amount-btn { flex: 1; padding: 0.7rem; background: rgba(212,160,23,0.08); border: 1px solid rgba(212,160,23,0.15); border-radius: 10px; color: var(--gold, #D4A017); font-weight: 700; font-size: 1rem; cursor: pointer; transition: all 0.2s; min-width: 70px; }
        .gc-amount-btn.active, .gc-amount-btn:hover { background: rgba(212,160,23,0.2); border-color: var(--gold, #D4A017); }

        /* ─── ADDONS ADMIN ─── */
        .addons-section { margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid rgba(212,160,23,0.08); }
        .addons-section h3 { font-size: 0.85rem; color: var(--gold); margin-bottom: 0.6rem; }
        .addon-row { display: flex; align-items: center; gap: 0.5rem; padding: 0.4rem 0; border-bottom: 1px solid rgba(212,160,23,0.04); }
        .addon-name { flex: 1; font-size: 0.78rem; color: var(--cream); }
        .addon-price { font-size: 0.75rem; color: var(--gold); min-width: 50px; }
        .addon-cat { font-size: 0.65rem; color: var(--text-dim); background: rgba(255,255,255,0.03); padding: 0.1rem 0.4rem; border-radius: 4px; }
        .addon-remove { background: none; border: none; color: var(--text-dim); cursor: pointer; font-size: 0.8rem; padding: 0.2rem; }
        .addon-remove:hover { color: #e74c3c; }
        .addon-add-row { display: flex; gap: 0.4rem; margin-top: 0.5rem; flex-wrap: wrap; }
        .addon-add-row input, .addon-add-row select { padding: 0.35rem 0.5rem; background: rgba(255,255,255,0.03); border: 1px solid rgba(212,160,23,0.1); border-radius: 6px; color: var(--cream); font-size: 0.75rem; }
        .addon-add-row input { flex: 1; min-width: 80px; }
        .addon-add-row select { min-width: 80px; }
        .addon-add-btn { padding: 0.35rem 0.7rem; background: rgba(212,160,23,0.1); color: var(--gold); border: 1px solid rgba(212,160,23,0.15); border-radius: 6px; font-size: 0.72rem; cursor: pointer; }

        /* ─── MEDIA ADMIN (Testimonials + Social) ─── */
        .media-admin-section { margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid rgba(212,160,23,0.1); }
        .media-section-header { display: flex; align-items: center; gap: 0.8rem; margin-bottom: 0.8rem; }
        .media-section-header h3 { font-size: 1rem; color: var(--gold); margin: 0; flex: 1; }
        .media-admin-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 0.8rem; }
        .media-admin-card { background: rgba(255,255,255,0.02); border: 1px solid rgba(212,160,23,0.08); border-radius: 10px; overflow: hidden; }
        .media-thumb { width: 100%; height: 140px; background-size: cover; background-position: center; position: relative; background-color: rgba(0,0,0,0.3); }
        .media-thumb-img { width: 100%; height: 140px; object-fit: cover; display: block; }
        .media-play { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 36px; height: 36px; background: rgba(212,160,23,0.8); color: #111; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.9rem; }
        .media-info { padding: 0.5rem 0.6rem; }
        .media-name-input, .media-caption-input { width: 100%; background: rgba(255,255,255,0.03); border: 1px solid rgba(212,160,23,0.08); border-radius: 5px; padding: 0.3rem 0.5rem; color: var(--cream); font-size: 0.75rem; margin-bottom: 0.3rem; box-sizing: border-box; }
        .media-actions { display: flex; align-items: center; justify-content: flex-end; gap: 0.5rem; padding: 0.4rem 0.6rem; border-top: 1px solid rgba(212,160,23,0.05); }

        /* ─── GIFT CARDS ADMIN ─── */
        .gc-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 0.6rem; margin-bottom: 1rem; }
        .gc-stat { background: rgba(212,160,23,0.05); border: 1px solid rgba(212,160,23,0.08); border-radius: 10px; padding: 0.8rem; text-align: center; }
        .gc-stat-num { display: block; font-size: 1.2rem; font-weight: 700; color: var(--gold); }
        .gc-stat-label { font-size: 0.7rem; color: var(--text-dim); margin-top: 0.2rem; display: block; }
        .gc-admin-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 0.8rem; }
        .gc-card { background: rgba(255,255,255,0.02); border: 1px solid rgba(212,160,23,0.08); border-radius: 10px; overflow: hidden; }
        .gc-card-header { display: flex; justify-content: space-between; align-items: center; padding: 0.6rem 0.8rem; background: rgba(212,160,23,0.04); }
        .gc-code { font-family: monospace; font-size: 0.85rem; color: var(--gold); font-weight: 600; letter-spacing: 0.5px; }
        .gc-status { font-size: 0.65rem; padding: 0.15rem 0.5rem; border-radius: 10px; font-weight: 600; }
        .gc-active { background: rgba(39,174,96,0.15); color: #27ae60; }
        .gc-used { background: rgba(149,165,166,0.15); color: #95a5a6; }
        .gc-inactive { background: rgba(231,76,60,0.15); color: #e74c3c; }
        .gc-card-body { padding: 0.6rem 0.8rem; }
        .gc-row { display: flex; justify-content: space-between; font-size: 0.75rem; color: var(--text-dim); padding: 0.2rem 0; }
        .gc-row strong { color: var(--cream); }

        /* ── EXPENSES ── */
        .expenses-summary-strip { background: rgba(212,160,23,0.07); border: 1px solid rgba(212,160,23,0.18); border-radius: 10px; padding: 1rem 1.25rem; margin-bottom: 1.25rem; }
        .expenses-summary-strip .exp-total { font-size: 1.25rem; font-weight: 700; color: var(--gold); margin-bottom: 0.5rem; }
        .expenses-summary-strip .exp-breakdown { display: flex; flex-wrap: wrap; gap: 0.5rem 1.25rem; font-size: 0.78rem; color: var(--text-dim); }
        .expenses-summary-strip .exp-breakdown span strong { color: var(--cream); }
        .expenses-filter-bar { display: flex; flex-wrap: wrap; align-items: center; gap: 0.6rem; margin-bottom: 1.25rem; }
        .expenses-filter-bar input[type="month"] { padding: 0.45rem 0.75rem; background: rgba(255,255,255,0.05); border: 1px solid rgba(212,160,23,0.25); border-radius: 8px; color: var(--cream); font-size: 0.82rem; cursor: pointer; }
        .expenses-filter-bar input[type="month"]:focus { outline: none; border-color: var(--gold); }
        .expense-card { background: var(--card-bg); border: 1px solid rgba(255,255,255,0.06); border-left: 3px solid var(--gold); border-radius: 10px; padding: 0.9rem 1.1rem; margin-bottom: 0.75rem; display: flex; align-items: flex-start; gap: 1rem; }
        .expense-card:hover { border-color: rgba(212,160,23,0.4); }
        .expense-card .exp-main { flex: 1; min-width: 0; }
        .expense-card .exp-top { display: flex; align-items: center; gap: 0.6rem; flex-wrap: wrap; margin-bottom: 0.35rem; }
        .expense-card .exp-date { font-size: 0.78rem; color: var(--text-dim); }
        .expense-card .exp-amount { margin-left: auto; font-size: 1.05rem; font-weight: 700; color: var(--gold); white-space: nowrap; }
        .expense-card .exp-desc { font-size: 0.85rem; color: var(--cream); opacity: 0.85; }
        .expense-card .exp-actions { display: flex; flex-direction: column; gap: 0.4rem; align-items: flex-end; }
        .exp-badge { display: inline-block; padding: 0.15rem 0.55rem; border-radius: 20px; font-size: 0.68rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.04em; }
        .exp-badge-Ingredients { background: rgba(76,175,80,0.15); color: #4caf50; }
        .exp-badge-Utilities { background: rgba(33,150,243,0.15); color: #2196f3; }
        .exp-badge-Staff { background: rgba(255,152,0,0.15); color: #ff9800; }
        .exp-badge-Equipment { background: rgba(156,39,176,0.15); color: #ce93d8; }
        .exp-badge-Rent { background: rgba(244,67,54,0.15); color: #f44336; }
        .exp-badge-Marketing { background: rgba(0,150,136,0.15); color: #4db6ac; }
        .exp-badge-Other { background: rgba(158,158,158,0.15); color: #9e9e9e; }
        .exp-bill-thumb { width: 72px; height: 72px; object-fit: cover; border-radius: 6px; cursor: pointer; border: 1px solid rgba(255,255,255,0.12); flex-shrink: 0; }
        .exp-bill-placeholder { width: 72px; height: 72px; border-radius: 6px; border: 1px dashed rgba(255,255,255,0.12); display: flex; align-items: center; justify-content: center; font-size: 1.4rem; flex-shrink: 0; color: var(--text-dim); }
        .expense-modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.75); z-index: 9998; }
        .expense-modal-box { position: fixed; top: 50%; left: 50%; transform: translate(-50%,-50%); z-index: 9999; background: #1a1008; border: 1px solid rgba(212,160,23,0.3); border-radius: 14px; padding: 1.75rem 2rem; width: min(480px, 94vw); max-height: 90vh; overflow-y: auto; }
        .expense-modal-box h3 { color: var(--gold); margin: 0 0 1.25rem; font-size: 1.1rem; }
        .exp-form-row { margin-bottom: 1rem; }
        .exp-form-row label { display: block; font-size: 0.75rem; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.07em; margin-bottom: 0.3rem; }
        .exp-form-row input, .exp-form-row select, .exp-form-row textarea { width: 100%; padding: 0.65rem 0.9rem; background: rgba(255,255,255,0.05); border: 1px solid rgba(212,160,23,0.2); border-radius: 8px; color: var(--cream); font-size: 0.88rem; box-sizing: border-box; }
        .exp-form-row input:focus, .exp-form-row select:focus, .exp-form-row textarea:focus { outline: none; border-color: var(--gold); }
        .exp-form-row select option { background: #1a1008; }
        .exp-bill-upload-area { border: 1px dashed rgba(212,160,23,0.3); border-radius: 8px; padding: 0.9rem; text-align: center; cursor: pointer; margin-top: 0.5rem; }
        .exp-bill-upload-area:hover { border-color: var(--gold); background: rgba(212,160,23,0.04); }
        #exp-bill-preview { max-width: 100%; max-height: 160px; border-radius: 6px; margin-top: 0.6rem; display: none; }
        .exp-modal-btns { display: flex; gap: 0.75rem; margin-top: 1.5rem; }
        .exp-modal-btns button { flex: 1; padding: 0.65rem; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 0.88rem; }
        .exp-save-btn { background: var(--gold); color: #1a1008; border: none; }
        .exp-save-btn:hover { background: #e8b422; }
        .exp-cancel-btn { background: transparent; color: var(--text-dim); border: 1px solid rgba(255,255,255,0.15); }
        .exp-cancel-btn:hover { border-color: rgba(255,255,255,0.35); color: var(--cream); }
        #exp-modal-msg { font-size: 0.8rem; margin-top: 0.5rem; min-height: 1.2em; }
        .exp-img-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.92); z-index: 10000; display: flex; align-items: center; justify-content: center; cursor: zoom-out; }
        .exp-img-overlay img { max-width: 90vw; max-height: 90vh; border-radius: 8px; }
        .exp-scan-btn { display: block; width: 100%; margin-top: 0.6rem; padding: 0.6rem 1rem; background: rgba(212,160,23,0.12); border: 1px solid rgba(212,160,23,0.35); border-radius: 8px; color: var(--gold); font-size: 0.82rem; font-weight: 600; cursor: pointer; transition: background 0.2s, border-color 0.2s; }
        .exp-scan-btn:hover { background: rgba(212,160,23,0.2); border-color: var(--gold); }
        .exp-scan-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .exp-ocr-confidence-high { color: #4caf50; }
        .exp-ocr-confidence-medium { color: #ff9800; }
        .exp-ocr-confidence-low { color: #f44336; }

        /* Expenses: View toggle + Download */
        .exp-toolbar { display: flex; align-items: center; gap: 0.6rem; flex-wrap: wrap; }
        .exp-view-toggle { display: inline-flex; border: 1px solid rgba(212,160,23,0.3); border-radius: 8px; overflow: hidden; }
        .exp-view-toggle button { padding: 0.4rem 0.85rem; font-size: 0.78rem; font-weight: 600; background: transparent; color: var(--text-dim); border: none; cursor: pointer; transition: background 0.2s, color 0.2s; }
        .exp-view-toggle button.active { background: var(--gold); color: #1a1008; }
        .exp-view-toggle button:hover:not(.active) { background: rgba(212,160,23,0.1); color: var(--cream); }
        .exp-download-btn { padding: 0.4rem 0.85rem; font-size: 0.78rem; font-weight: 600; background: transparent; color: var(--gold); border: 1px solid rgba(212,160,23,0.3); border-radius: 8px; cursor: pointer; transition: background 0.2s, border-color 0.2s; white-space: nowrap; }
        .exp-download-btn:hover { background: rgba(212,160,23,0.12); border-color: var(--gold); }

        /* Expenses: Table view */
        .exp-table-wrap { overflow-x: auto; border-radius: 10px; border: 1px solid rgba(255,255,255,0.06); }
        .exp-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        .exp-table th { position: sticky; top: 0; background: rgba(212,160,23,0.1); color: var(--gold); font-size: 0.72rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.06em; padding: 0.7rem 0.9rem; text-align: left; white-space: nowrap; border-bottom: 1px solid rgba(212,160,23,0.2); }
        .exp-table th:last-child, .exp-table td:last-child { text-align: right; }
        .exp-table td { padding: 0.65rem 0.9rem; color: var(--cream); border-bottom: 1px solid rgba(255,255,255,0.05); vertical-align: middle; }
        .exp-table tr:hover td { background: rgba(212,160,23,0.04); }
        .exp-table .exp-amount-cell { font-weight: 700; color: var(--gold); white-space: nowrap; text-align: right; }
        .exp-table .exp-desc-cell { max-width: 260px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; opacity: 0.85; }
        .exp-table .exp-date-cell { white-space: nowrap; color: var(--text-dim); font-size: 0.8rem; }
        .exp-table .exp-actions-cell { display: flex; gap: 0.4rem; justify-content: flex-end; }
        .exp-table tfoot td { font-weight: 700; border-top: 2px solid rgba(212,160,23,0.25); background: rgba(212,160,23,0.06); }
    </style>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>
</head>
<body>

    <!-- Admin Login -->
    <div id="admin-login" class="admin-login">
        <div class="login-box">
            <img src="../amogha-logo.png" alt="Amogha" class="login-logo">
            <h2>Admin Panel</h2>
            <p>Enter admin PIN to access orders</p>
            <input type="password" id="admin-pin" placeholder="Enter PIN" maxlength="6" inputmode="numeric" autofocus>
            <button class="login-btn" onclick="adminLogin()">Access Dashboard</button>
            <p id="login-error" class="login-error"></p>
        </div>
    </div>

    <!-- Admin Dashboard (hidden until login) -->
    <div id="admin-dashboard" style="display:none;">
        <header class="admin-header">
            <div class="header-left">
                <img src="../amogha-logo.png" alt="Amogha" class="header-logo">
                <h1><span>Amogha</span> Admin</h1>
            </div>
            <div class="header-right">
                <span class="live-label"><span class="live-dot"></span> Live</span>
                <button class="theme-toggle" id="theme-toggle" onclick="toggleAdminTheme()" title="Toggle theme">
                    <svg class="icon-moon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>
                    <svg class="icon-sun" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
                </button>
                <select class="theme-selector" id="theme-selector" onchange="setSeasonalTheme(this.value)" title="Seasonal Theme">
                    <option value="default">Default Theme</option>
                    <option value="diwali">Diwali</option>
                    <option value="holi">Holi</option>
                    <option value="christmas">Christmas</option>
                </select>
                <button class="logout-btn" onclick="adminLogout()">Logout</button>
                <div class="admin-stats">
                    <span class="stat-badge"><span class="label">Orders </span><span class="num" id="stat-total">0</span></span>
                    <span class="stat-badge"><span class="label">Today </span><span class="num" id="stat-today">0</span></span>
                    <span class="stat-badge"><span class="label">Revenue </span><span class="num" id="stat-revenue">0</span></span>
                </div>
            </div>
        </header>

        <div class="admin-tabs" id="admin-tabs">
            <button class="admin-tab active" data-tab="orders" onclick="switchTab('orders',this)">Orders</button>
            <button class="admin-tab" data-tab="menu" onclick="switchTab('menu',this)">Menu</button>
            <button class="admin-tab" data-tab="specials" onclick="switchTab('specials',this)">Specials</button>
            <button class="admin-tab" data-tab="slideshow" onclick="switchTab('slideshow',this)">Slideshow</button>
            <button class="admin-tab" data-tab="analytics" onclick="switchTab('analytics',this)">Analytics</button>
            <button class="admin-tab" data-tab="coupons" onclick="switchTab('coupons',this)">Coupons</button>
            <button class="admin-tab" data-tab="reviews" onclick="switchTab('reviews',this)">Reviews</button>
            <button class="admin-tab" data-tab="crm" onclick="switchTab('crm',this)">Customers</button>
            <button class="admin-tab" data-tab="giftcards" onclick="switchTab('giftcards',this)">Gift Cards</button>
            <button class="admin-tab" data-tab="daily-special" onclick="switchTab('daily-special',this);loadDailySpecialAdmin()">Daily Special</button>
            <button class="admin-tab" data-tab="expenses" onclick="switchTab('expenses',this)">Expenses</button>
        </div>

        <div class="filters">
            <button class="filter-btn active" onclick="filterOrders('all', this)">All</button>
            <button class="filter-btn" onclick="filterOrders('pending', this)">Pending</button>
            <button class="filter-btn" onclick="filterOrders('confirmed', this)">Confirmed</button>
            <button class="filter-btn" onclick="filterOrders('preparing', this)">Preparing</button>
            <button class="filter-btn" onclick="filterOrders('delivered', this)">Delivered</button>
            <button class="filter-btn" onclick="filterOrders('cancelled', this)">Cancelled</button>
            <button class="filter-btn export-btn" onclick="exportOrdersCSV()" title="Export filtered orders as CSV">Export CSV</button>
        </div>

        <div class="orders-container" id="orders-container">
            <div class="empty-state">
                <div class="icon">...</div>
                <p>Loading orders...</p>
            </div>
        </div>

        <div id="menu-panel" class="admin-panel" style="display:none;">
            <div class="panel-header">
                <h2 class="panel-title">Menu Items</h2>
                <button class="add-special-btn" onclick="showAddMenuItem()">+ Add Item</button>
            </div>
            <div class="menu-category-filters" id="menu-cat-filters">
                <!-- Dynamically populated with category filter chips -->
            </div>
            <div class="menu-admin-grid" id="menu-admin-grid">
                <!-- Dynamically populated -->
            </div>
            <div class="addons-section">
                <h3>Item Add-ons (Extra Cheese, Sides, etc.)</h3>
                <div id="addons-list"></div>
                <div class="addon-add-row">
                    <input type="text" id="addon-name-input" placeholder="Add-on name">
                    <input type="number" id="addon-price-input" placeholder="₹" min="1" style="max-width:70px">
                    <select id="addon-cat-input">
                        <option value="topping">Topping</option>
                        <option value="side">Side</option>
                        <option value="sauce">Sauce</option>
                        <option value="drink">Drink</option>
                        <option value="extra">Extra</option>
                    </select>
                    <button class="addon-add-btn" onclick="addAddon()">+ Add</button>
                </div>
            </div>
        </div>

        <div id="specials-panel" class="admin-panel" style="display:none;">
            <div class="panel-header">
                <h2 class="panel-title">Today's Specials</h2>
                <button class="add-special-btn" onclick="showAddSpecial()">+ Add Special</button>
            </div>
            <div class="specials-admin-grid" id="specials-admin-grid">
                <!-- Dynamically populated -->
            </div>
        </div>

        <div id="slideshow-panel" class="admin-panel" style="display:none;">
            <div class="panel-header">
                <h2 class="panel-title">Hero Slideshow</h2>
                <label class="slide-upload-btn" for="slide-file-input">+ Add Slide</label>
                <input type="file" id="slide-file-input" accept="image/jpeg,image/png,image/webp,video/mp4,video/webm" style="display:none">
            </div>
            <div class="slide-upload-status" id="slide-upload-status"></div>
            <div class="slides-admin-grid" id="slides-admin-grid">
                <div class="empty-state"><div class="icon">🖼️</div><p>No slides yet</p><p class="sub">Click "+ Add Slide" to upload images or videos</p></div>
            </div>

            <!-- Testimonials Management -->
            <div class="media-admin-section">
                <div class="media-section-header">
                    <h3>Customer Testimonials</h3>
                    <label class="slide-upload-btn" for="testimonial-file-input">+ Add Testimonial</label>
                    <input type="file" id="testimonial-file-input" accept="video/mp4,video/webm" style="display:none">
                </div>
                <div class="slide-upload-status" id="testimonial-upload-status"></div>
                <div class="media-admin-grid" id="testimonials-admin-grid">
                    <div class="empty-state"><div class="icon">🎬</div><p>No testimonials yet</p></div>
                </div>
            </div>

            <!-- Social Feed Management -->
            <div class="media-admin-section">
                <div class="media-section-header">
                    <h3>Social Feed Posts</h3>
                    <label class="slide-upload-btn" for="social-file-input">+ Add Post</label>
                    <input type="file" id="social-file-input" accept="image/jpeg,image/png,image/webp" style="display:none">
                </div>
                <div class="slide-upload-status" id="social-upload-status"></div>
                <div class="media-admin-grid" id="social-admin-grid">
                    <div class="empty-state"><div class="icon">📸</div><p>No social posts yet</p></div>
                </div>
            </div>
        </div>

        <!-- Analytics Panel -->
        <div id="analytics-panel" class="admin-panel" style="display:none;">
            <div class="panel-header">
                <h2 class="panel-title">Analytics Dashboard</h2>
                <select id="analytics-range" onchange="renderAnalytics()">
                    <option value="7">Last 7 Days</option>
                    <option value="30" selected>Last 30 Days</option>
                    <option value="0">All Time</option>
                </select>
            </div>
            <div class="analytics-summary" id="analytics-summary"></div>
            <div class="analytics-charts">
                <div class="chart-box"><h3>Revenue by Day</h3><canvas id="revenue-chart" height="220"></canvas></div>
                <div class="chart-box"><h3>Top 10 Items</h3><div id="top-items-list"></div></div>
            </div>
            <div class="analytics-charts">
                <div class="chart-box"><h3>Orders by Hour</h3><div id="peak-hours-grid" class="peak-grid"></div></div>
                <div class="chart-box"><h3>Order Status Breakdown</h3><div id="status-breakdown"></div></div>
            </div>
        </div>

        <!-- Coupons Panel -->
        <div id="coupons-panel" class="admin-panel" style="display:none;">
            <div class="panel-header">
                <h2 class="panel-title">Coupon Management</h2>
                <button class="add-special-btn" onclick="showAddCoupon()">+ Add Coupon</button>
            </div>
            <div class="coupons-admin-grid" id="coupons-admin-grid"></div>
        </div>

        <!-- Reviews Panel -->
        <div id="reviews-panel" class="admin-panel" style="display:none;">
            <div class="panel-header">
                <h2 class="panel-title">Customer Reviews</h2>
                <select id="review-sort" onchange="renderReviewsAdmin()">
                    <option value="newest">Newest First</option>
                    <option value="oldest">Oldest First</option>
                    <option value="highest">Highest Rated</option>
                    <option value="lowest">Lowest Rated</option>
                </select>
            </div>
            <div class="review-summary" id="review-summary"></div>
            <div class="reviews-admin-grid" id="reviews-admin-grid"></div>
        </div>

        <!-- CRM Panel -->
        <div id="crm-panel" class="admin-panel" style="display:none;">
            <div class="panel-header">
                <h2 class="panel-title">Customer CRM</h2>
                <select id="crm-sort" onchange="renderCRM()">
                    <option value="spent">Top Spenders</option>
                    <option value="orders">Most Orders</option>
                    <option value="recent">Most Recent</option>
                </select>
            </div>
            <div class="crm-summary" id="crm-summary"></div>
            <div class="crm-grid" id="crm-grid"></div>
        </div>

        <!-- Gift Cards Panel -->
        <!-- Daily Special Panel -->
        <div id="daily-special-panel" class="admin-panel" style="display:none;">
            <div class="panel-header">
                <h2 class="panel-title">Daily Special</h2>
                <button class="btn-primary" onclick="saveDailySpecial()">Save & Publish</button>
            </div>
            <div style="max-width:600px">
                <p style="color:#a09080;font-size:0.85rem;margin-bottom:1.5rem">This special appears on the homepage with a countdown to midnight. Toggle "Active" to show or hide it.</p>
                <div class="form-row" style="margin-bottom:1rem">
                    <label style="display:flex;align-items:center;gap:0.5rem;cursor:pointer;margin-bottom:1rem">
                        <input type="checkbox" id="ds-active" style="accent-color:#D4A017;width:18px;height:18px">
                        <span style="font-weight:600;color:#e8dcc8">Active (show on site)</span>
                    </label>
                </div>
                <div style="display:grid;gap:1rem">
                    <div>
                        <label style="display:block;font-size:0.78rem;color:#a09080;margin-bottom:0.3rem;text-transform:uppercase;letter-spacing:0.07em">Title</label>
                        <input type="text" id="ds-title" placeholder="e.g. Hyderabadi Biryani Special" style="width:100%;padding:0.7rem 1rem;background:rgba(255,255,255,0.05);border:1px solid rgba(212,160,23,0.2);border-radius:8px;color:#e8dcc8;font-size:0.9rem">
                    </div>
                    <div>
                        <label style="display:block;font-size:0.78rem;color:#a09080;margin-bottom:0.3rem;text-transform:uppercase;letter-spacing:0.07em">Description</label>
                        <textarea id="ds-desc" rows="2" placeholder="e.g. Slow-cooked dum biryani with raita and salan" style="width:100%;padding:0.7rem 1rem;background:rgba(255,255,255,0.05);border:1px solid rgba(212,160,23,0.2);border-radius:8px;color:#e8dcc8;font-size:0.9rem;resize:vertical"></textarea>
                    </div>
                    <div>
                        <label style="display:block;font-size:0.78rem;color:#a09080;margin-bottom:0.3rem;text-transform:uppercase;letter-spacing:0.07em">Price (₹)</label>
                        <input type="number" id="ds-price" placeholder="e.g. 299" style="width:100%;padding:0.7rem 1rem;background:rgba(255,255,255,0.05);border:1px solid rgba(212,160,23,0.2);border-radius:8px;color:#e8dcc8;font-size:0.9rem">
                    </div>
                    <div>
                        <label style="display:block;font-size:0.78rem;color:#a09080;margin-bottom:0.3rem;text-transform:uppercase;letter-spacing:0.07em">Image URL (optional)</label>
                        <input type="url" id="ds-image" placeholder="https://..." style="width:100%;padding:0.7rem 1rem;background:rgba(255,255,255,0.05);border:1px solid rgba(212,160,23,0.2);border-radius:8px;color:#e8dcc8;font-size:0.9rem">
                    </div>
                </div>
                <div id="ds-msg" style="margin-top:1rem;font-size:0.85rem;display:none"></div>
            </div>
        </div>

        <!-- ══════════════════════════════════════════════════════════ -->
        <!--  EXPENSES PANEL                                           -->
        <!-- ══════════════════════════════════════════════════════════ -->
        <div id="expenses-panel" class="admin-panel" style="display:none;">
            <div class="panel-header">
                <h2 class="panel-title">Expenses</h2>
                <div class="exp-toolbar">
                    <div class="exp-view-toggle" id="exp-view-toggle">
                        <button class="active" onclick="toggleExpView('card')">Cards</button>
                        <button onclick="toggleExpView('table')">Table</button>
                    </div>
                    <button class="exp-download-btn" onclick="downloadExpensesExcel()">Download Excel</button>
                    <button class="btn-primary" onclick="openExpenseModal()">+ Add Expense</button>
                </div>
            </div>
            <div id="expenses-summary"></div>
            <div class="expenses-filter-bar" id="expenses-filter-bar">
                <input type="month" id="exp-month-input" onchange="expMonthFilter=this.value;expDateFrom='';expDateTo='';document.getElementById('exp-date-from').value='';document.getElementById('exp-date-to').value='';renderExpenses()">
                <label style="font-size:0.75rem;color:var(--text-dim);margin-left:0.5rem">From</label>
                <input type="date" id="exp-date-from" onchange="expDateFrom=this.value;expMonthFilter='';document.getElementById('exp-month-input').value='';renderExpenses()" style="padding:0.4rem 0.6rem;background:rgba(255,255,255,0.05);border:1px solid rgba(212,160,23,0.25);border-radius:8px;color:var(--cream);font-size:0.8rem">
                <label style="font-size:0.75rem;color:var(--text-dim)">To</label>
                <input type="date" id="exp-date-to" onchange="expDateTo=this.value;expMonthFilter='';document.getElementById('exp-month-input').value='';renderExpenses()" style="padding:0.4rem 0.6rem;background:rgba(255,255,255,0.05);border:1px solid rgba(212,160,23,0.25);border-radius:8px;color:var(--cream);font-size:0.8rem">
                <button class="filter-btn active" onclick="expCatFilter='all';document.querySelectorAll('#expenses-filter-bar .filter-btn').forEach(function(b){b.classList.remove('active')});this.classList.add('active');renderExpenses()">All</button>
                <button class="filter-btn" onclick="expCatFilter='Ingredients';document.querySelectorAll('#expenses-filter-bar .filter-btn').forEach(function(b){b.classList.remove('active')});this.classList.add('active');renderExpenses()">Ingredients</button>
                <button class="filter-btn" onclick="expCatFilter='Utilities';document.querySelectorAll('#expenses-filter-bar .filter-btn').forEach(function(b){b.classList.remove('active')});this.classList.add('active');renderExpenses()">Utilities</button>
                <button class="filter-btn" onclick="expCatFilter='Staff';document.querySelectorAll('#expenses-filter-bar .filter-btn').forEach(function(b){b.classList.remove('active')});this.classList.add('active');renderExpenses()">Staff</button>
                <button class="filter-btn" onclick="expCatFilter='Equipment';document.querySelectorAll('#expenses-filter-bar .filter-btn').forEach(function(b){b.classList.remove('active')});this.classList.add('active');renderExpenses()">Equipment</button>
                <button class="filter-btn" onclick="expCatFilter='Rent';document.querySelectorAll('#expenses-filter-bar .filter-btn').forEach(function(b){b.classList.remove('active')});this.classList.add('active');renderExpenses()">Rent</button>
                <button class="filter-btn" onclick="expCatFilter='Marketing';document.querySelectorAll('#expenses-filter-bar .filter-btn').forEach(function(b){b.classList.remove('active')});this.classList.add('active');renderExpenses()">Marketing</button>
                <button class="filter-btn" onclick="expCatFilter='Other';document.querySelectorAll('#expenses-filter-bar .filter-btn').forEach(function(b){b.classList.remove('active')});this.classList.add('active');renderExpenses()">Other</button>
            </div>
            <div id="expenses-list"></div>
            <div id="expenses-table-wrap" class="exp-table-wrap" style="display:none;"></div>
        </div>

        <!-- Add/Edit Expense Modal -->
        <div id="expense-modal" style="display:none;">
            <div class="expense-modal-overlay" onclick="closeExpenseModal()"></div>
            <div class="expense-modal-box">
                <h3 id="expense-modal-title">Add Expense</h3>
                <input type="hidden" id="expense-edit-id">
                <input type="hidden" id="expense-pending-bill-url">
                <div class="exp-form-row">
                    <label>Date</label>
                    <input type="date" id="exp-date">
                </div>
                <div class="exp-form-row">
                    <label>Category</label>
                    <select id="exp-category">
                        <option value="">Select category…</option>
                        <option value="Ingredients">Ingredients / Raw Materials</option>
                        <option value="Utilities">Utilities (Electricity, Water, Gas)</option>
                        <option value="Staff">Staff / Salaries</option>
                        <option value="Equipment">Equipment / Maintenance</option>
                        <option value="Rent">Rent</option>
                        <option value="Marketing">Marketing</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="exp-form-row">
                    <label>Amount (₹)</label>
                    <input type="number" id="exp-amount" placeholder="0" min="1" step="0.01">
                </div>
                <div class="exp-form-row">
                    <label>Description</label>
                    <textarea id="exp-description" rows="2" placeholder="e.g. Chicken and vegetables from market"></textarea>
                </div>
                <div class="exp-form-row">
                    <label>Paid By</label>
                    <input type="text" id="exp-paid-by" placeholder="e.g. Ravi, Suresh, Owner">
                </div>
                <div class="exp-form-row">
                    <label>Bill / Receipt (optional)</label>
                    <div class="exp-bill-upload-area" onclick="document.getElementById('exp-bill-input').click()">
                        <div style="color:var(--text-dim);font-size:0.82rem">📷 Click to upload bill image or PDF</div>
                        <div style="color:var(--text-dim);font-size:0.72rem;margin-top:0.2rem">JPG, PNG, WebP or PDF · max 2MB</div>
                        <img id="exp-bill-preview" src="" alt="Bill preview">
                        <div id="exp-pdf-indicator" style="display:none;color:var(--gold);font-size:0.82rem;margin-top:0.5rem"></div>
                    </div>
                    <input type="file" id="exp-bill-input" accept="image/jpeg,image/png,image/webp,application/pdf" style="display:none" onchange="handleExpBillSelect()">
                    <div id="exp-bill-status" style="font-size:0.78rem;color:var(--text-dim);margin-top:0.35rem"></div>
                    <button type="button" id="exp-scan-btn" class="exp-scan-btn" onclick="scanBillOCR()" style="display:none">🔍 Scan Bill &amp; Auto-fill</button>
                    <div id="exp-ocr-status" style="font-size:0.78rem;margin-top:0.35rem;min-height:1.2em"></div>
                </div>
                <div id="exp-modal-msg"></div>
                <div class="exp-modal-btns">
                    <button class="exp-save-btn" onclick="saveExpense()">Save</button>
                    <button class="exp-cancel-btn" onclick="closeExpenseModal()">Cancel</button>
                </div>
            </div>
        </div>

        <div id="giftcards-panel" class="admin-panel" style="display:none;">
            <div class="panel-header">
                <h2 class="panel-title">Gift Cards</h2>
            </div>
            <div class="gc-summary" id="gc-summary"></div>
            <div class="gc-admin-grid" id="gc-admin-grid">
                <div class="empty-state"><div class="icon">🎁</div><p>No gift cards yet</p><p class="sub">Customers can purchase gift cards from the main site</p></div>
            </div>
        </div>
    </div>

    <!-- Add Coupon Modal -->
    <div id="add-coupon-modal" class="admin-modal" style="display:none;">
        <div class="admin-modal-content">
            <div class="admin-modal-header">
                <h3>Add Coupon</h3>
                <button class="modal-close" onclick="hideAddCoupon()">&times;</button>
            </div>
            <input type="text" id="coupon-code-input" placeholder="Coupon code (e.g. SAVE20)" style="text-transform:uppercase">
            <div style="display:flex;gap:0.5rem">
                <input type="number" id="coupon-discount" placeholder="Discount value" min="1" style="flex:1">
                <select id="coupon-type" style="flex:1">
                    <option value="percent">% Percent</option>
                    <option value="flat">₹ Flat</option>
                </select>
            </div>
            <input type="text" id="coupon-label" placeholder="Label (e.g. 20% off on orders)">
            <div style="display:flex;gap:0.5rem">
                <input type="number" id="coupon-min-order" placeholder="Min order ₹ (0=none)" min="0" style="flex:1">
                <input type="number" id="coupon-max-discount" placeholder="Max discount ₹ (0=none)" min="0" style="flex:1">
            </div>
            <div style="display:flex;gap:0.5rem">
                <input type="number" id="coupon-usage-limit" placeholder="Usage limit (0=unlimited)" min="0" style="flex:1">
                <input type="date" id="coupon-expires" style="flex:1">
            </div>
            <button class="add-special-confirm" onclick="addCoupon()">Add Coupon</button>
        </div>
    </div>

    <!-- Add Special Modal -->
    <div id="add-special-modal" class="admin-modal" style="display:none;">
        <div class="admin-modal-content">
            <div class="admin-modal-header">
                <h3>Add Today's Special</h3>
                <button class="modal-close" onclick="hideAddSpecial()">&times;</button>
            </div>
            <select id="special-item-select"><option value="">Select a menu item...</option></select>
            <input type="number" id="special-price" placeholder="Special price (₹)">
            <input type="text" id="special-badge" placeholder="Badge text (e.g. Amogha Special)" value="Special">
            <textarea id="special-desc" placeholder="Description" rows="2"></textarea>
            <button class="add-special-confirm" onclick="addSpecial()">Add Special</button>
        </div>
    </div>

    <!-- Add Menu Item Modal -->
    <div id="add-menu-modal" class="admin-modal" style="display:none;">
        <div class="admin-modal-content">
            <div class="admin-modal-header">
                <h3>Add Menu Item</h3>
                <button class="modal-close" onclick="hideAddMenuItem()">&times;</button>
            </div>
            <input type="text" id="menu-item-name" placeholder="Item name (e.g. Paneer Tikka)">
            <input type="number" id="menu-item-price" placeholder="Price (₹)" min="0">
            <select id="menu-item-category">
                <option value="">Select category...</option>
                <option value="Starters">Starters</option>
                <option value="Curries">Curries</option>
                <option value="Biryanis">Biryanis</option>
                <option value="Kebabs & Grill">Kebabs & Grill</option>
                <option value="Noodles">Noodles</option>
                <option value="Fried Rice">Fried Rice</option>
                <option value="Rotis & Naan">Rotis & Naan</option>
                <option value="Beverages">Beverages</option>
            </select>
            <select id="menu-item-type">
                <option value="veg">Veg</option>
                <option value="non-veg">Non-Veg</option>
            </select>
            <input type="text" id="menu-item-badge" placeholder="Badge (optional, e.g. Bestseller, New)">
            <div class="mac-image-section" style="margin-top:0.5rem;">
                <label class="mac-img-upload-btn" for="menu-item-image" style="display:inline-flex;margin-bottom:0.4rem;">&#128247; Attach Image (optional)</label>
                <input type="file" id="menu-item-image" accept="image/jpeg,image/png,image/webp" style="display:none">
                <img id="new-item-img-preview" src="" alt="" loading="lazy" style="display:none;width:100%;max-height:100px;object-fit:cover;border-radius:8px;margin-top:0.4rem;border:1px solid rgba(212,160,23,0.12);">
            </div>
            <button class="add-special-confirm" onclick="addMenuItem()">Add to Menu</button>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
    <!-- Storage SDK removed — using Cloudinary for image hosting -->
    <script>
        firebase.initializeApp({
            apiKey: "AIzaSyCM0LIBRVreGCYBknlk_xEXoomzM3JAVBw",
            authDomain: "amogha-cafe.firebaseapp.com",
            projectId: "amogha-cafe",
            storageBucket: "amogha-cafe.firebasestorage.app",
            messagingSenderId: "1000994409697",
            appId: "1:1000994409697:web:983214bafab529d6a2fba0"
        });
        var db = firebase.firestore();

        // XSS escape helper
        function escHtml(str) {
            if (!str) return '';
            return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;');
        }

        // ─── CLOUDINARY IMAGE UPLOAD ───
        var CLOUDINARY_CLOUD = 'dix3mcvjr';
        var CLOUDINARY_PRESET = 'phlsyh0s';
        var CLOUDINARY_URL = 'https://api.cloudinary.com/v1_1/' + CLOUDINARY_CLOUD + '/image/upload';
        var MAX_IMAGE_SIZE = 2 * 1024 * 1024;
        var ACCEPTED_TYPES = ['image/jpeg', 'image/png', 'image/webp'];

        function sanitizeFileName(itemId) {
            return itemId.replace(/[^a-zA-Z0-9]/g, '_');
        }

        function uploadMenuImage(itemId) {
            var safeId = sanitizeFileName(itemId);
            var fileInput = document.getElementById('img-input-' + safeId);
            if (!fileInput || !fileInput.files[0]) return;

            var file = fileInput.files[0];
            if (!ACCEPTED_TYPES.includes(file.type)) {
                alert('Please select a JPG, PNG, or WebP image.');
                fileInput.value = '';
                return;
            }
            if (file.size > MAX_IMAGE_SIZE) {
                alert('Image must be under 2MB. Please compress or resize it.');
                fileInput.value = '';
                return;
            }

            var statusEl = document.getElementById('img-status-' + safeId);
            var previewEl = document.getElementById('img-preview-' + safeId);
            if (statusEl) statusEl.textContent = 'Uploading...';

            var formData = new FormData();
            formData.append('file', file);
            formData.append('upload_preset', CLOUDINARY_PRESET);
            formData.append('public_id', 'menu_' + safeId);

            var xhr = new XMLHttpRequest();
            xhr.open('POST', CLOUDINARY_URL);

            xhr.upload.onprogress = function(e) {
                if (e.lengthComputable) {
                    var pct = Math.round((e.loaded / e.total) * 100);
                    if (statusEl) statusEl.textContent = 'Uploading ' + pct + '%...';
                }
            };

            xhr.onerror = function() {
                if (statusEl) statusEl.textContent = 'Upload failed. Try again.';
                setTimeout(function() { if (statusEl) statusEl.textContent = ''; }, 3000);
            };

            xhr.onload = function() {
                if (xhr.status !== 200) {
                    console.error('Cloudinary error:', xhr.responseText);
                    if (statusEl) statusEl.textContent = 'Upload failed. Try again.';
                    setTimeout(function() { if (statusEl) statusEl.textContent = ''; }, 3000);
                    return;
                }
                var res = JSON.parse(xhr.responseText);
                var url = res.secure_url;

                db.collection('menu').doc(itemId).update({
                    imageUrl: url,
                    updatedAt: new Date().toISOString()
                }).then(function() {
                    if (statusEl) statusEl.textContent = 'Uploaded!';
                    if (previewEl) {
                        previewEl.src = url;
                        previewEl.style.display = 'block';
                    }
                    var removeBtn = document.getElementById('img-remove-' + safeId);
                    if (removeBtn) removeBtn.style.display = 'inline-block';
                    setTimeout(function() { if (statusEl) statusEl.textContent = ''; }, 2000);
                }).catch(function(err) {
                    console.error('Firestore update error:', err);
                    if (statusEl) statusEl.textContent = 'Saved but DB update failed.';
                });
            };

            xhr.send(formData);
            fileInput.value = '';
        }

        function removeMenuImage(itemId) {
            if (!confirm('Remove image for "' + itemId + '"?')) return;
            var safeId = sanitizeFileName(itemId);

            db.collection('menu').doc(itemId).update({
                imageUrl: firebase.firestore.FieldValue.delete(),
                updatedAt: new Date().toISOString()
            }).catch(function(err) { console.error('Remove image URL error:', err); });

            var previewEl = document.getElementById('img-preview-' + safeId);
            if (previewEl) { previewEl.src = ''; previewEl.style.display = 'none'; }
            var removeBtn = document.getElementById('img-remove-' + safeId);
            if (removeBtn) removeBtn.style.display = 'none';
        }

        // Admin PIN (change this!)
        var ADMIN_PIN = '240124';

        // Theme toggle
        (function() {
            var saved = localStorage.getItem('admin-theme');
            if (saved === 'light') document.body.classList.add('light-mode');
        })();

        function toggleAdminTheme() {
            document.body.classList.toggle('light-mode');
            var isLight = document.body.classList.contains('light-mode');
            localStorage.setItem('admin-theme', isLight ? 'light' : 'dark');
        }

        var allOrders = [];
        var currentFilter = 'all';

        function adminLogin() {
            var pin = document.getElementById('admin-pin').value;
            if (pin === ADMIN_PIN) {
                document.getElementById('admin-login').style.display = 'none';
                var dash = document.getElementById('admin-dashboard');
                dash.style.display = 'block';
                dash.classList.add('dashboard-enter');
                loadOrders();
            } else {
                var errEl = document.getElementById('login-error');
                errEl.textContent = 'Invalid PIN. Access denied.';
                // Shake the login box
                var box = document.querySelector('.login-box');
                box.style.animation = 'none';
                box.offsetHeight; // reflow
                box.style.animation = 'shake 0.4s ease';
            }
        }

        function adminLogout() {
            document.getElementById('admin-dashboard').style.display = 'none';
            document.getElementById('admin-dashboard').classList.remove('dashboard-enter');
            document.getElementById('admin-login').style.display = 'flex';
            document.getElementById('admin-pin').value = '';
            document.getElementById('login-error').textContent = '';
        }

        document.getElementById('admin-pin').addEventListener('keydown', function(e) {
            if (e.key === 'Enter') adminLogin();
        });

        // ─── SEASONAL THEME ───
        function setSeasonalTheme(theme) {
            db.collection('settings').doc('global').set({ activeTheme: theme }, { merge: true })
                .then(function() { alert('Theme set to ' + (theme === 'default' ? 'Default' : theme) + '. Customer site will update on next load.'); })
                .catch(function(err) { console.error('Theme error:', err); });
        }

        // Load current theme into selector
        (function() {
            db.collection('settings').doc('global').get().then(function(doc) {
                if (doc.exists && doc.data().activeTheme) {
                    var sel = document.getElementById('theme-selector');
                    if (sel) sel.value = doc.data().activeTheme;
                }
            }).catch(function() {});
        })();

        // ─── ADDONS MANAGEMENT (in Menu tab) ───
        var allAddons = [];

        function loadAddons() {
            db.collection('addons').orderBy('sortOrder').onSnapshot(function(snap) {
                allAddons = [];
                snap.forEach(function(doc) { allAddons.push({ id: doc.id, ...doc.data() }); });
                renderAddonsAdmin();
            });
        }

        function renderAddonsAdmin() {
            var container = document.getElementById('addons-list');
            if (!container) return;
            if (allAddons.length === 0) {
                container.innerHTML = '<p style="font-size:0.72rem;color:var(--text-dim)">No add-ons yet. Add some below.</p>';
            } else {
                container.innerHTML = allAddons.map(function(a) {
                    return '<div class="addon-row">' +
                        '<span class="addon-name">' + escHtml(a.name) + '</span>' +
                        '<span class="addon-price">\u20B9' + a.price + '</span>' +
                        '<span class="addon-cat">' + escHtml(a.category || 'extra') + '</span>' +
                        '<button class="addon-remove" onclick="removeAddon(\'' + escHtml(a.id) + '\')" title="Remove">✕</button>' +
                    '</div>';
                }).join('');
            }
        }

        function addAddon() {
            var name = document.getElementById('addon-name-input').value.trim();
            var price = parseInt(document.getElementById('addon-price-input').value);
            var category = document.getElementById('addon-cat-input').value;
            if (!name || !price) { alert('Name and price are required'); return; }
            db.collection('addons').add({
                name: name, price: price, category: category,
                active: true, sortOrder: allAddons.length + 1, createdAt: new Date().toISOString()
            }).then(function() {
                document.getElementById('addon-name-input').value = '';
                document.getElementById('addon-price-input').value = '';
            });
        }

        function removeAddon(id) {
            if (!confirm('Remove this add-on?')) return;
            db.collection('addons').doc(id).delete();
        }

        function loadOrders() {
            db.collection('orders').orderBy('createdAt', 'desc').onSnapshot(function(snapshot) {
                allOrders = [];
                snapshot.forEach(function(doc) {
                    allOrders.push({ id: doc.id, ...doc.data() });
                });
                updateStats();
                renderOrders();
            }, function(err) { console.error('Orders snapshot error:', err); });
        }

        function updateStats() {
            var today = new Date().toISOString().split('T')[0];
            var todayOrders = allOrders.filter(function(o) { return o.createdAt && o.createdAt.startsWith(today); });
            var revenue = allOrders.filter(function(o) { return o.status !== 'cancelled'; }).reduce(function(sum, o) { return sum + (o.total || 0); }, 0);

            animateCount('stat-total', allOrders.length);
            animateCount('stat-today', todayOrders.length);
            document.getElementById('stat-revenue').textContent = '\u20B9' + revenue.toLocaleString('en-IN');
        }

        function animateCount(id, target) {
            var el = document.getElementById(id);
            var current = parseInt(el.textContent) || 0;
            if (current === target) return;
            var step = target > current ? 1 : -1;
            var timer = setInterval(function() {
                current += step;
                el.textContent = current;
                if (current === target) clearInterval(timer);
            }, 30);
        }

        function renderOrders() {
            var container = document.getElementById('orders-container');
            var filtered = currentFilter === 'all' ? allOrders : allOrders.filter(function(o) { return o.status === currentFilter; });

            if (filtered.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="icon">\uD83D\uDCCB</div><p>No ' + (currentFilter === 'all' ? '' : currentFilter + ' ') + 'orders yet</p><p class="sub">Orders will appear here in real-time</p></div>';
                return;
            }

            container.innerHTML = filtered.map(function(order, i) {
                var date = order.createdAt ? new Date(order.createdAt) : new Date();
                var timeStr = date.toLocaleString('en-IN', { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' });

                var itemsHtml = '';
                if (order.items && order.items.length) {
                    itemsHtml = order.items.map(function(item) {
                        return '<div class="order-item"><span>' + escHtml(item.name) + ' <span class="qty">x' + parseInt(item.qty) + '</span></span><span class="item-price">\u20B9' + (Number(item.price) * parseInt(item.qty)) + '</span></div>';
                    }).join('');
                }

                var notesHtml = order.notes ? '<div class="order-notes">' + escHtml(order.notes) + '</div>' : '';

                var safeStatus = escHtml(order.status || 'pending');

                var waPhone = (order.phone || '').replace(/\D/g, '');
                var waMsg = 'Hi ' + escHtml(order.customer || 'Customer') + '! Your Amogha order is now *' + (safeStatus).toUpperCase() + '*. Thank you for choosing Amogha!';

                return '<div class="order-card" style="animation-delay:' + (i * 0.05) + 's">' +
                    '<div class="order-top">' +
                        '<span class="order-time">' + escHtml(timeStr) + '</span>' +
                        '<span class="order-status status-' + safeStatus + '">' + safeStatus + '</span>' +
                    '</div>' +
                    '<div class="order-customer"><strong>' + escHtml(order.customer || 'Unknown') + '</strong><span class="phone">' + escHtml(order.phone || '') + '</span></div>' +
                    (order.address ? '<div class="order-address">' + escHtml(order.address) + '</div>' : '') +
                    notesHtml +
                    '<div class="order-items">' + itemsHtml + '</div>' +
                    '<div class="order-total">' +
                        '<span class="amount">\u20B9' + (Number(order.total) || 0) + '</span>' +
                        '<span class="payment">' + escHtml(order.payment || 'N/A') + '</span>' +
                    '</div>' +
                    '<div class="order-actions">' +
                        '<select data-order-id="' + escHtml(order.id) + '" onchange="updateStatus(this.dataset.orderId, this.value, \'' + escHtml(order.customer || '') + '\', \'' + waPhone + '\')">' +
                            '<option value="pending"' + (order.status === 'pending' ? ' selected' : '') + '>Pending</option>' +
                            '<option value="confirmed"' + (order.status === 'confirmed' ? ' selected' : '') + '>Confirmed</option>' +
                            '<option value="preparing"' + (order.status === 'preparing' ? ' selected' : '') + '>Preparing</option>' +
                            '<option value="delivered"' + (order.status === 'delivered' ? ' selected' : '') + '>Delivered</option>' +
                            '<option value="cancelled"' + (order.status === 'cancelled' ? ' selected' : '') + '>Cancelled</option>' +
                        '</select>' +
                        '<a class="wa-update-btn" href="https://wa.me/' + waPhone + '?text=' + encodeURIComponent(waMsg) + '" target="_blank" rel="noopener" title="Send WhatsApp update">WhatsApp</a>' +
                        '<button class="order-print-btn" onclick="printOrder(\'' + escHtml(order.id) + '\')">Print</button>' +
                    '</div>' +
                '</div>';
            }).join('');
        }

        function filterOrders(status, btn) {
            currentFilter = status;
            document.querySelectorAll('.filter-btn').forEach(function(b) { b.classList.remove('active'); });
            btn.classList.add('active');
            renderOrders();
        }

        function updateStatus(orderId, newStatus, customerName, phone) {
            var updateData = { status: newStatus };
            // If marking as preparing, prompt for ETA and record start time
            if (newStatus === 'preparing') {
                var eta = prompt('Set ETA for this order (minutes):', '20');
                if (eta === null) return; // staff cancelled
                updateData.etaMinutes = parseInt(eta) || 20;
                updateData.preparingAt = new Date().toISOString();
            }
            db.collection('orders').doc(orderId).update(updateData).then(function() {
                // Write notification for customer
                if (phone) {
                    var statusMessages = {
                        confirmed: 'Your order has been confirmed!',
                        preparing: 'We are preparing your order now!',
                        delivered: 'Your order has been delivered. Enjoy!',
                        cancelled: 'Your order has been cancelled.'
                    };
                    if (statusMessages[newStatus]) {
                        db.collection('notifications').add({
                            orderId: orderId,
                            userPhone: phone,
                            title: 'Order Update - Amogha',
                            body: statusMessages[newStatus],
                            status: newStatus,
                            createdAt: new Date().toISOString(),
                            read: false
                        });
                    }
                }
            }).catch(function(err) { console.error('Update status error:', err); });
        }

        // ─── TAB SWITCHING ───
        var currentTab = 'orders';

        function switchTab(tab, btn) {
            currentTab = tab;
            document.querySelectorAll('.admin-tab').forEach(function(t) { t.classList.remove('active'); });
            btn.classList.add('active');

            // Hide all panels
            document.querySelector('.filters').style.display = tab === 'orders' ? 'flex' : 'none';
            document.getElementById('orders-container').style.display = tab === 'orders' ? 'grid' : 'none';
            document.getElementById('menu-panel').style.display = tab === 'menu' ? 'block' : 'none';
            document.getElementById('specials-panel').style.display = tab === 'specials' ? 'block' : 'none';
            document.getElementById('slideshow-panel').style.display = tab === 'slideshow' ? 'block' : 'none';
            document.getElementById('analytics-panel').style.display = tab === 'analytics' ? 'block' : 'none';
            document.getElementById('coupons-panel').style.display = tab === 'coupons' ? 'block' : 'none';
            document.getElementById('reviews-panel').style.display = tab === 'reviews' ? 'block' : 'none';
            document.getElementById('crm-panel').style.display = tab === 'crm' ? 'block' : 'none';
            document.getElementById('giftcards-panel').style.display = tab === 'giftcards' ? 'block' : 'none';
            document.getElementById('expenses-panel').style.display = tab === 'expenses' ? 'block' : 'none';

            // Load data if needed
            if (tab === 'menu' && allMenuItems.length === 0) { loadMenuItems(); loadAddons(); }
            if (tab === 'specials' && allSpecials.length === 0) loadSpecials();
            if (tab === 'slideshow') {
                if (allHeroSlides.length === 0) loadHeroSlides();
                if (allTestimonials.length === 0) loadTestimonialsAdmin();
                if (allSocialPosts.length === 0) loadSocialPostsAdmin();
            }
            if (tab === 'analytics' && !analyticsLoaded) loadAnalytics();
            if (tab === 'coupons' && allCoupons.length === 0) loadCoupons();
            if (tab === 'reviews' && allReviews.length === 0) loadReviews();
            if (tab === 'crm' && crmCustomers.length === 0) loadCRM();
            if (tab === 'giftcards' && allGiftCards.length === 0) loadGiftCardsAdmin();
            if (tab === 'expenses' && !expensesLoaded) loadExpenses();
        }

        // ─── MENU MANAGEMENT ───
        var allMenuItems = [];
        var menuCatFilter = 'all';

        function loadMenuItems() {
            db.collection('menu').orderBy('sortOrder').onSnapshot(function(snapshot) {
                allMenuItems = [];
                snapshot.forEach(function(doc) {
                    allMenuItems.push({ id: doc.id, ...doc.data() });
                });
                renderMenuCatFilters();
                renderMenuAdmin();
            }, function(err) { console.error('Menu snapshot error:', err); });
        }

        function renderMenuCatFilters() {
            var cats = ['all'];
            allMenuItems.forEach(function(item) {
                if (cats.indexOf(item.category) === -1) cats.push(item.category);
            });
            var container = document.getElementById('menu-cat-filters');
            container.innerHTML = cats.map(function(cat) {
                var active = cat === menuCatFilter ? ' active' : '';
                var label = cat === 'all' ? 'All' : escHtml(cat);
                return '<button class="filter-btn' + active + '" onclick="filterMenuCat(\'' + escHtml(cat) + '\', this)">' + label + '</button>';
            }).join('');
        }

        function filterMenuCat(cat, btn) {
            menuCatFilter = cat;
            document.querySelectorAll('#menu-cat-filters .filter-btn').forEach(function(b) { b.classList.remove('active'); });
            btn.classList.add('active');
            renderMenuAdmin();
        }

        function renderMenuAdmin() {
            var container = document.getElementById('menu-admin-grid');
            var items = menuCatFilter === 'all' ? allMenuItems : allMenuItems.filter(function(i) { return i.category === menuCatFilter; });

            if (items.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="icon">📋</div><p>No menu items found</p></div>';
                return;
            }

            container.innerHTML = items.map(function(item) {
                var typeClass = item.type === 'veg' ? 'veg' : 'nv';
                var unavailClass = !item.available ? ' mac-unavailable' : '';
                var checked = item.available ? ' checked' : '';
                var badgeHtml = item.badge ? '<span class="mac-badge">' + escHtml(item.badge) + '</span>' : '';
                var safeKey = item.id.replace(/[^a-zA-Z0-9]/g, '_');
                var escapedId = item.id.replace(/'/g, "\\'");

                return '<div class="mac' + unavailClass + '" data-id="' + escHtml(item.id) + '">' +
                    '<div class="mac-top">' +
                        '<span class="mac-type ' + typeClass + '"></span>' +
                        '<span class="mac-name">' + escHtml(item.name) + '</span>' +
                        badgeHtml +
                    '</div>' +
                    '<div class="mac-cat">' + escHtml(item.category) + '</div>' +
                    '<div class="mac-image-section">' +
                        '<img class="mac-img-preview" id="img-preview-' + safeKey + '" src="' + (item.imageUrl ? escHtml(item.imageUrl) : '') + '" alt="" loading="lazy" style="' + (item.imageUrl ? 'display:block' : 'display:none') + '">' +
                        '<div class="mac-img-controls">' +
                            '<label class="mac-img-upload-btn" for="img-input-' + safeKey + '" title="Upload image">&#128247; Upload</label>' +
                            '<input type="file" id="img-input-' + safeKey + '" accept="image/jpeg,image/png,image/webp" style="display:none" onchange="uploadMenuImage(\'' + escapedId + '\')">' +
                            '<button class="mac-img-remove-btn" id="img-remove-' + safeKey + '" onclick="removeMenuImage(\'' + escapedId + '\')" style="' + (item.imageUrl ? 'display:inline-block' : 'display:none') + '" title="Remove image">Remove</button>' +
                            '<span class="mac-img-status" id="img-status-' + safeKey + '"></span>' +
                        '</div>' +
                    '</div>' +
                    '<div class="mac-controls">' +
                        '<div class="mac-price-row">' +
                            '<span class="mac-price" id="price-display-' + safeKey + '">₹' + item.price + '</span>' +
                            '<input class="mac-price-input" id="price-input-' + safeKey + '" type="number" value="' + item.price + '" style="display:none" min="0">' +
                            '<button class="mac-edit-btn" id="edit-btn-' + safeKey + '" onclick="togglePriceEdit(\'' + escapedId + '\')">Edit</button>' +
                            '<button class="mac-save-btn" id="save-btn-' + safeKey + '" onclick="savePrice(\'' + escapedId + '\')" style="display:none">Save</button>' +
                        '</div>' +
                        '<label class="toggle-switch">' +
                            '<input type="checkbox"' + checked + ' onchange="toggleAvail(\'' + escapedId + '\', this.checked)">' +
                            '<span class="toggle-slider"></span>' +
                        '</label>' +
                        '<button class="mac-remove-btn" onclick="removeMenuItem(\'' + escapedId + '\')" title="Remove item">✕</button>' +
                    '</div>' +
                    '<div class="mac-stock-row">' +
                        (function() {
                            var stock = item.stock;
                            var threshold = item.lowStockThreshold || 10;
                            var stockBadge = '';
                            if (stock !== null && stock !== undefined) {
                                if (stock === 0) stockBadge = '<span class="stock-badge stock-out">Out of Stock</span>';
                                else if (stock <= threshold) stockBadge = '<span class="stock-badge stock-low">Low: ' + stock + '</span>';
                                else stockBadge = '<span class="stock-badge stock-ok">' + stock + ' in stock</span>';
                            }
                            return '<label class="stock-label">Stock:</label>' +
                                '<input type="number" class="stock-input" id="stock-' + safeKey + '" value="' + (stock != null ? stock : '') + '" placeholder="∞" min="0">' +
                                '<button class="stock-save-btn" onclick="saveStock(\'' + escapedId + '\')">Set</button>' +
                                stockBadge;
                        })() +
                    '</div>' +
                '</div>';
            }).join('');
        }

        function togglePriceEdit(itemId) {
            var key = itemId.replace(/[^a-zA-Z0-9]/g, '_');
            var display = document.getElementById('price-display-' + key);
            var input = document.getElementById('price-input-' + key);
            var editBtn = document.getElementById('edit-btn-' + key);
            var saveBtn = document.getElementById('save-btn-' + key);

            display.style.display = 'none';
            input.style.display = 'inline-block';
            input.focus();
            input.select();
            editBtn.style.display = 'none';
            saveBtn.style.display = 'inline-block';
        }

        function savePrice(itemId) {
            var key = itemId.replace(/[^a-zA-Z0-9]/g, '_');
            var input = document.getElementById('price-input-' + key);
            var newPrice = parseInt(input.value);
            if (isNaN(newPrice) || newPrice < 0) return;

            db.collection('menu').doc(itemId).update({
                price: newPrice,
                updatedAt: new Date().toISOString()
            }).catch(function(err) { console.error('Save price error:', err); });
            // UI will update via onSnapshot
        }

        function toggleAvail(itemId, available) {
            db.collection('menu').doc(itemId).update({
                available: available,
                updatedAt: new Date().toISOString()
            }).catch(function(err) { console.error('Toggle availability error:', err); });
        }

        // ─── SPECIALS MANAGEMENT ───
        var allSpecials = [];

        function loadSpecials() {
            db.collection('specials').orderBy('sortOrder').onSnapshot(function(snapshot) {
                allSpecials = [];
                snapshot.forEach(function(doc) {
                    allSpecials.push({ id: doc.id, ...doc.data() });
                });
                renderSpecialsAdmin();
            }, function(err) { console.error('Specials snapshot error:', err); });
        }

        function renderSpecialsAdmin() {
            var container = document.getElementById('specials-admin-grid');

            if (allSpecials.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="icon">⭐</div><p>No specials yet</p><p class="sub">Click "Add Special" to create one</p></div>';
                return;
            }

            container.innerHTML = allSpecials.map(function(item) {
                return '<div class="sac">' +
                    '<div class="sac-info">' +
                        '<div class="sac-name">' + escHtml(item.name) + '<span class="sac-badge">' + escHtml(item.badge || 'Special') + '</span></div>' +
                        '<div class="sac-meta">' + escHtml(item.description || '') + '</div>' +
                    '</div>' +
                    '<span class="sac-price">₹' + (Number(item.price) || 0) + '</span>' +
                    '<div class="sac-actions">' +
                        '<label class="toggle-switch">' +
                            '<input type="checkbox"' + (item.available ? ' checked' : '') + ' onchange="toggleSpecialAvail(\'' + escHtml(item.id) + '\', this.checked)">' +
                            '<span class="toggle-slider"></span>' +
                        '</label>' +
                        '<button class="sac-remove" onclick="removeSpecial(\'' + escHtml(item.id) + '\')">Remove</button>' +
                    '</div>' +
                '</div>';
            }).join('');
        }

        function showAddSpecial() {
            // Populate the select with menu items
            var select = document.getElementById('special-item-select');
            select.innerHTML = '<option value="">Select a menu item...</option>';
            allMenuItems.forEach(function(item) {
                select.innerHTML += '<option value="' + escHtml(item.name) + '" data-price="' + (Number(item.price) || 0) + '">' + escHtml(item.name) + ' (₹' + (Number(item.price) || 0) + ')</option>';
            });
            // Load menu items if not yet loaded
            if (allMenuItems.length === 0) {
                db.collection('menu').orderBy('sortOrder').get().then(function(snapshot) {
                    allMenuItems = [];
                    snapshot.forEach(function(doc) {
                        allMenuItems.push({ id: doc.id, ...doc.data() });
                    });
                    select.innerHTML = '<option value="">Select a menu item...</option>';
                    allMenuItems.forEach(function(item) {
                        select.innerHTML += '<option value="' + escHtml(item.name) + '" data-price="' + (Number(item.price) || 0) + '">' + escHtml(item.name) + ' (₹' + (Number(item.price) || 0) + ')</option>';
                    });
                }).catch(function(err) { console.error('Failed to load menu items:', err); });
            }

            // Auto-fill price when item selected
            select.onchange = function() {
                var option = select.options[select.selectedIndex];
                if (option.dataset.price) {
                    document.getElementById('special-price').value = option.dataset.price;
                }
            };

            document.getElementById('add-special-modal').style.display = 'flex';
        }

        function hideAddSpecial() {
            document.getElementById('add-special-modal').style.display = 'none';
        }

        function addSpecial() {
            var name = document.getElementById('special-item-select').value;
            var price = parseInt(document.getElementById('special-price').value);
            var badge = document.getElementById('special-badge').value.trim() || 'Special';
            var desc = document.getElementById('special-desc').value.trim();

            if (!name || isNaN(price)) { alert('Please select an item and enter a price.'); return; }

            db.collection('specials').add({
                name: name,
                price: price,
                badge: badge,
                description: desc,
                available: true,
                sortOrder: allSpecials.length + 1,
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            }).catch(function(err) { console.error('Add special error:', err); });

            hideAddSpecial();
            // Reset form
            document.getElementById('special-item-select').value = '';
            document.getElementById('special-price').value = '';
            document.getElementById('special-badge').value = 'Special';
            document.getElementById('special-desc').value = '';
        }

        function toggleSpecialAvail(specialId, available) {
            db.collection('specials').doc(specialId).update({
                available: available,
                updatedAt: new Date().toISOString()
            }).catch(function(err) { console.error('Toggle special availability error:', err); });
        }

        function removeSpecial(specialId) {
            if (confirm('Remove this special?')) {
                db.collection('specials').doc(specialId).delete().catch(function(err) { console.error('Remove special error:', err); });
            }
        }

        // ─── ADD / REMOVE MENU ITEMS ───
        function showAddMenuItem() {
            document.getElementById('menu-item-name').value = '';
            document.getElementById('menu-item-price').value = '';
            document.getElementById('menu-item-category').value = '';
            document.getElementById('menu-item-type').value = 'veg';
            document.getElementById('menu-item-badge').value = '';
            document.getElementById('add-menu-modal').style.display = 'flex';
            document.getElementById('menu-item-name').focus();
        }

        function hideAddMenuItem() {
            document.getElementById('add-menu-modal').style.display = 'none';
        }

        function addMenuItem() {
            var name = document.getElementById('menu-item-name').value.trim();
            var price = parseInt(document.getElementById('menu-item-price').value);
            var category = document.getElementById('menu-item-category').value;
            var type = document.getElementById('menu-item-type').value;
            var badge = document.getElementById('menu-item-badge').value.trim();

            if (!name) { alert('Please enter an item name.'); return; }
            if (isNaN(price) || price < 0) { alert('Please enter a valid price.'); return; }
            if (!category) { alert('Please select a category.'); return; }

            // Check if item with same name already exists
            var exists = allMenuItems.some(function(item) { return item.name.toLowerCase() === name.toLowerCase(); });
            if (exists) { alert('An item with this name already exists.'); return; }

            var maxSort = allMenuItems.reduce(function(max, item) { return Math.max(max, item.sortOrder || 0); }, 0);

            db.collection('menu').doc(name).set({
                name: name,
                price: price,
                category: category,
                type: type,
                badge: badge || '',
                available: true,
                sortOrder: maxSort + 1,
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            }).then(function() {
                var imgInput = document.getElementById('menu-item-image');
                if (imgInput && imgInput.files[0]) {
                    var file = imgInput.files[0];
                    var fd = new FormData();
                    fd.append('file', file);
                    fd.append('upload_preset', CLOUDINARY_PRESET);
                    fd.append('public_id', 'menu_' + sanitizeFileName(name));
                    return fetch(CLOUDINARY_URL, { method: 'POST', body: fd })
                        .then(function(r) { return r.json(); })
                        .then(function(res) {
                            if (res.secure_url) {
                                return db.collection('menu').doc(name).update({ imageUrl: res.secure_url });
                            }
                        });
                }
            }).catch(function(err) { console.error('Add menu item error:', err); });

            hideAddMenuItem();
            var newPreview = document.getElementById('new-item-img-preview');
            if (newPreview) { newPreview.src = ''; newPreview.style.display = 'none'; }
            var newImgInput = document.getElementById('menu-item-image');
            if (newImgInput) newImgInput.value = '';
        }

        function removeMenuItem(itemId) {
            if (confirm('Remove "' + itemId + '" from the menu? This cannot be undone.')) {
                db.collection('menu').doc(itemId).delete().catch(function(err) { console.error('Remove menu item error:', err); });
            }
        }

        // Preview image in Add Menu Item modal
        (function() {
            var imgInput = document.getElementById('menu-item-image');
            if (imgInput) {
                imgInput.addEventListener('change', function() {
                    var file = this.files[0];
                    var preview = document.getElementById('new-item-img-preview');
                    if (file && ACCEPTED_TYPES.includes(file.type) && file.size <= MAX_IMAGE_SIZE) {
                        var reader = new FileReader();
                        reader.onload = function(e) {
                            preview.src = e.target.result;
                            preview.style.display = 'block';
                        };
                        reader.readAsDataURL(file);
                    } else if (file) {
                        alert(file.size > MAX_IMAGE_SIZE ? 'Image must be under 2MB.' : 'Please select JPG, PNG, or WebP.');
                        imgInput.value = '';
                        if (preview) preview.style.display = 'none';
                    }
                });
            }
        })();

        // ─── HERO SLIDESHOW MANAGEMENT ───
        var allHeroSlides = [];
        var SLIDE_VIDEO_TYPES = ['video/mp4', 'video/webm'];
        var SLIDE_IMAGE_TYPES = ['image/jpeg', 'image/png', 'image/webp'];
        var MAX_VIDEO_SIZE = 10 * 1024 * 1024;

        function loadHeroSlides() {
            db.collection('heroSlides').orderBy('sortOrder').onSnapshot(function(snapshot) {
                allHeroSlides = [];
                snapshot.forEach(function(doc) {
                    allHeroSlides.push({ id: doc.id, ...doc.data() });
                });
                renderSlideshowAdmin();
            }, function(err) { console.error('Hero slides snapshot error:', err); });
        }

        function renderSlideshowAdmin() {
            var container = document.getElementById('slides-admin-grid');
            if (allHeroSlides.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="icon">🖼️</div><p>No slides yet</p><p class="sub">Click "+ Add Slide" to upload images or videos</p></div>';
                return;
            }

            container.innerHTML = allHeroSlides.map(function(slide, idx) {
                var isVideo = slide.type === 'video';
                var previewHtml = isVideo
                    ? '<video class="sc-preview" src="' + escHtml(slide.url) + '" muted loop playsinline></video>'
                    : '<img class="sc-preview" src="' + escHtml(slide.url) + '" alt="" loading="lazy">';
                var activeClass = slide.active ? '' : ' sc-inactive';
                var checked = slide.active ? ' checked' : '';

                return '<div class="sc' + activeClass + '" data-id="' + escHtml(slide.id) + '">' +
                    previewHtml +
                    '<div class="sc-info">' +
                        '<span class="sc-type-badge ' + (isVideo ? 'video' : 'image') + '">' + (isVideo ? 'Video' : 'Image') + '</span>' +
                        '<span class="sc-order">#' + (idx + 1) + '</span>' +
                    '</div>' +
                    '<div class="sc-controls">' +
                        '<button class="sc-move-btn" onclick="moveSlide(\'' + slide.id + '\', -1)" title="Move up" ' + (idx === 0 ? 'disabled' : '') + '>&#9650;</button>' +
                        '<button class="sc-move-btn" onclick="moveSlide(\'' + slide.id + '\', 1)" title="Move down" ' + (idx === allHeroSlides.length - 1 ? 'disabled' : '') + '>&#9660;</button>' +
                        '<label class="toggle-switch"><input type="checkbox"' + checked + ' onchange="toggleSlideActive(\'' + slide.id + '\', this.checked)"><span class="toggle-slider"></span></label>' +
                        '<button class="sc-remove-btn" onclick="removeHeroSlide(\'' + slide.id + '\')" title="Remove">&#10005;</button>' +
                    '</div>' +
                '</div>';
            }).join('');
        }

        // Upload slide file
        document.getElementById('slide-file-input').addEventListener('change', function() {
            var file = this.files[0];
            if (!file) return;

            var isVideo = SLIDE_VIDEO_TYPES.includes(file.type);
            var isImage = SLIDE_IMAGE_TYPES.includes(file.type);

            if (!isVideo && !isImage) {
                alert('Please select JPG, PNG, WebP image or MP4, WebM video.');
                this.value = '';
                return;
            }
            if (isImage && file.size > MAX_IMAGE_SIZE) {
                alert('Image must be under 2MB.');
                this.value = '';
                return;
            }
            if (isVideo && file.size > MAX_VIDEO_SIZE) {
                alert('Video must be under 10MB.');
                this.value = '';
                return;
            }

            var statusEl = document.getElementById('slide-upload-status');
            statusEl.textContent = 'Uploading...';

            var uploadUrl = isVideo
                ? 'https://api.cloudinary.com/v1_1/' + CLOUDINARY_CLOUD + '/video/upload'
                : CLOUDINARY_URL;

            var formData = new FormData();
            formData.append('file', file);
            formData.append('upload_preset', CLOUDINARY_PRESET);
            formData.append('public_id', 'hero_slide_' + Date.now());

            var xhr = new XMLHttpRequest();
            xhr.open('POST', uploadUrl);

            xhr.upload.onprogress = function(e) {
                if (e.lengthComputable) {
                    var pct = Math.round((e.loaded / e.total) * 100);
                    statusEl.textContent = 'Uploading ' + pct + '%...';
                }
            };

            xhr.onerror = function() {
                statusEl.textContent = 'Upload failed. Try again.';
                setTimeout(function() { statusEl.textContent = ''; }, 3000);
            };

            xhr.onload = function() {
                if (xhr.status !== 200) {
                    console.error('Cloudinary error:', xhr.responseText);
                    statusEl.textContent = 'Upload failed. Try again.';
                    setTimeout(function() { statusEl.textContent = ''; }, 3000);
                    return;
                }
                var res = JSON.parse(xhr.responseText);
                var maxSort = allHeroSlides.reduce(function(max, s) { return Math.max(max, s.sortOrder || 0); }, 0);

                db.collection('heroSlides').add({
                    url: res.secure_url,
                    type: isVideo ? 'video' : 'image',
                    sortOrder: maxSort + 1,
                    active: true,
                    createdAt: new Date().toISOString()
                }).then(function() {
                    statusEl.textContent = 'Added!';
                    setTimeout(function() { statusEl.textContent = ''; }, 2000);
                }).catch(function(err) {
                    console.error('Firestore add error:', err);
                    statusEl.textContent = 'Uploaded but save failed.';
                });
            };

            xhr.send(formData);
            this.value = '';
        });

        function removeHeroSlide(docId) {
            if (!confirm('Remove this slide?')) return;
            db.collection('heroSlides').doc(docId).delete().catch(function(err) { console.error('Remove slide error:', err); });
        }

        function toggleSlideActive(docId, active) {
            db.collection('heroSlides').doc(docId).update({ active: active }).catch(function(err) { console.error('Toggle slide error:', err); });
        }

        function moveSlide(docId, direction) {
            var idx = allHeroSlides.findIndex(function(s) { return s.id === docId; });
            var swapIdx = idx + direction;
            if (swapIdx < 0 || swapIdx >= allHeroSlides.length) return;

            var current = allHeroSlides[idx];
            var swap = allHeroSlides[swapIdx];

            var batch = db.batch();
            batch.update(db.collection('heroSlides').doc(current.id), { sortOrder: swap.sortOrder });
            batch.update(db.collection('heroSlides').doc(swap.id), { sortOrder: current.sortOrder });
            batch.commit().catch(function(err) { console.error('Move slide error:', err); });
        }

        // ─── TESTIMONIALS ADMIN ───
        var allTestimonials = [];

        function loadTestimonialsAdmin() {
            db.collection('testimonials').orderBy('sortOrder').onSnapshot(function(snapshot) {
                allTestimonials = [];
                snapshot.forEach(function(doc) { allTestimonials.push({ id: doc.id, ...doc.data() }); });
                renderTestimonialsAdmin();
            });
        }

        function renderTestimonialsAdmin() {
            var container = document.getElementById('testimonials-admin-grid');
            if (allTestimonials.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="icon">🎬</div><p>No testimonials yet</p></div>';
                return;
            }
            container.innerHTML = allTestimonials.map(function(t) {
                var thumbUrl = t.thumbnailUrl || (t.videoUrl ? t.videoUrl.replace('/upload/', '/upload/f_jpg,pg_1,w_200/') : '');
                return '<div class="media-admin-card">' +
                    '<div class="media-thumb" style="background-image:url(' + escHtml(thumbUrl) + ')"><div class="media-play">▶</div></div>' +
                    '<div class="media-info">' +
                        '<input class="media-name-input" value="' + escHtml(t.customerName || '') + '" placeholder="Customer name" onchange="updateTestimonial(\'' + t.id + '\', \'customerName\', this.value)">' +
                        '<input class="media-caption-input" value="' + escHtml(t.caption || '') + '" placeholder="Caption" onchange="updateTestimonial(\'' + t.id + '\', \'caption\', this.value)">' +
                    '</div>' +
                    '<div class="media-actions">' +
                        '<label class="toggle-switch"><input type="checkbox"' + (t.active ? ' checked' : '') + ' onchange="updateTestimonial(\'' + t.id + '\', \'active\', this.checked)"><span class="toggle-slider"></span></label>' +
                        '<button class="sc-remove-btn" onclick="removeTestimonial(\'' + t.id + '\')" title="Remove">&#10005;</button>' +
                    '</div>' +
                '</div>';
            }).join('');
        }

        function updateTestimonial(id, field, value) {
            var update = {};
            update[field] = value;
            db.collection('testimonials').doc(id).update(update);
        }

        function removeTestimonial(id) {
            if (!confirm('Remove this testimonial?')) return;
            db.collection('testimonials').doc(id).delete();
        }

        // Upload testimonial video
        document.getElementById('testimonial-file-input').addEventListener('change', function() {
            var file = this.files[0];
            if (!file) return;
            if (file.size > MAX_VIDEO_SIZE) { alert('Video must be under 10MB.'); this.value = ''; return; }

            var statusEl = document.getElementById('testimonial-upload-status');
            statusEl.textContent = 'Uploading video...';

            var formData = new FormData();
            formData.append('file', file);
            formData.append('upload_preset', CLOUDINARY_PRESET);
            formData.append('public_id', 'testimonial_' + Date.now());

            var xhr = new XMLHttpRequest();
            xhr.open('POST', 'https://api.cloudinary.com/v1_1/' + CLOUDINARY_CLOUD + '/video/upload');
            xhr.upload.onprogress = function(e) { if (e.lengthComputable) statusEl.textContent = 'Uploading ' + Math.round((e.loaded / e.total) * 100) + '%...'; };
            xhr.onerror = function() { statusEl.textContent = 'Upload failed.'; setTimeout(function() { statusEl.textContent = ''; }, 3000); };
            xhr.onload = function() {
                if (xhr.status !== 200) { statusEl.textContent = 'Upload failed.'; setTimeout(function() { statusEl.textContent = ''; }, 3000); return; }
                var res = JSON.parse(xhr.responseText);
                var maxSort = allTestimonials.reduce(function(m, t) { return Math.max(m, t.sortOrder || 0); }, 0);
                db.collection('testimonials').add({
                    videoUrl: res.secure_url,
                    thumbnailUrl: res.secure_url.replace('/upload/', '/upload/f_jpg,pg_1,w_400/'),
                    customerName: '',
                    caption: '',
                    active: true,
                    sortOrder: maxSort + 1,
                    createdAt: new Date().toISOString()
                }).then(function() { statusEl.textContent = 'Added!'; setTimeout(function() { statusEl.textContent = ''; }, 2000); });
            };
            xhr.send(formData);
            this.value = '';
        });

        // ─── SOCIAL POSTS ADMIN ───
        var allSocialPosts = [];

        function loadSocialPostsAdmin() {
            db.collection('socialPosts').orderBy('sortOrder').onSnapshot(function(snapshot) {
                allSocialPosts = [];
                snapshot.forEach(function(doc) { allSocialPosts.push({ id: doc.id, ...doc.data() }); });
                renderSocialPostsAdmin();
            });
        }

        function renderSocialPostsAdmin() {
            var container = document.getElementById('social-admin-grid');
            if (allSocialPosts.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="icon">📸</div><p>No social posts yet</p></div>';
                return;
            }
            container.innerHTML = allSocialPosts.map(function(p) {
                return '<div class="media-admin-card">' +
                    '<img class="media-thumb-img" src="' + escHtml(p.imageUrl) + '" alt="" loading="lazy">' +
                    '<div class="media-info">' +
                        '<input class="media-caption-input" value="' + escHtml(p.caption || '') + '" placeholder="Caption" onchange="updateSocialPost(\'' + p.id + '\', \'caption\', this.value)">' +
                        '<input class="media-caption-input" value="' + escHtml(p.link || '') + '" placeholder="Link (optional)" onchange="updateSocialPost(\'' + p.id + '\', \'link\', this.value)">' +
                    '</div>' +
                    '<div class="media-actions">' +
                        '<label class="toggle-switch"><input type="checkbox"' + (p.active ? ' checked' : '') + ' onchange="updateSocialPost(\'' + p.id + '\', \'active\', this.checked)"><span class="toggle-slider"></span></label>' +
                        '<button class="sc-remove-btn" onclick="removeSocialPost(\'' + p.id + '\')" title="Remove">&#10005;</button>' +
                    '</div>' +
                '</div>';
            }).join('');
        }

        function updateSocialPost(id, field, value) {
            var update = {};
            update[field] = value;
            db.collection('socialPosts').doc(id).update(update);
        }

        function removeSocialPost(id) {
            if (!confirm('Remove this social post?')) return;
            db.collection('socialPosts').doc(id).delete();
        }

        // Upload social post image
        document.getElementById('social-file-input').addEventListener('change', function() {
            var file = this.files[0];
            if (!file) return;
            if (file.size > MAX_IMAGE_SIZE) { alert('Image must be under 2MB.'); this.value = ''; return; }

            var statusEl = document.getElementById('social-upload-status');
            statusEl.textContent = 'Uploading...';

            var formData = new FormData();
            formData.append('file', file);
            formData.append('upload_preset', CLOUDINARY_PRESET);
            formData.append('public_id', 'social_' + Date.now());

            var xhr = new XMLHttpRequest();
            xhr.open('POST', CLOUDINARY_URL);
            xhr.upload.onprogress = function(e) { if (e.lengthComputable) statusEl.textContent = 'Uploading ' + Math.round((e.loaded / e.total) * 100) + '%...'; };
            xhr.onerror = function() { statusEl.textContent = 'Upload failed.'; setTimeout(function() { statusEl.textContent = ''; }, 3000); };
            xhr.onload = function() {
                if (xhr.status !== 200) { statusEl.textContent = 'Upload failed.'; setTimeout(function() { statusEl.textContent = ''; }, 3000); return; }
                var res = JSON.parse(xhr.responseText);
                var maxSort = allSocialPosts.reduce(function(m, p) { return Math.max(m, p.sortOrder || 0); }, 0);
                db.collection('socialPosts').add({
                    imageUrl: res.secure_url,
                    caption: '',
                    link: '',
                    active: true,
                    sortOrder: maxSort + 1,
                    createdAt: new Date().toISOString()
                }).then(function() { statusEl.textContent = 'Added!'; setTimeout(function() { statusEl.textContent = ''; }, 2000); });
            };
            xhr.send(formData);
            this.value = '';
        });

        // ─── GIFT CARDS ADMIN ───
        var allGiftCards = [];

        function loadGiftCardsAdmin() {
            db.collection('giftCards').orderBy('createdAt', 'desc').onSnapshot(function(snapshot) {
                allGiftCards = [];
                snapshot.forEach(function(doc) { allGiftCards.push({ id: doc.id, ...doc.data() }); });
                renderGiftCardsAdmin();
            }, function(err) { console.error('Gift cards load error:', err); });
        }

        function renderGiftCardsAdmin() {
            var container = document.getElementById('gc-admin-grid');
            var summary = document.getElementById('gc-summary');

            if (allGiftCards.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="icon">🎁</div><p>No gift cards yet</p><p class="sub">Customers can purchase gift cards from the main site</p></div>';
                summary.innerHTML = '';
                return;
            }

            var totalIssued = allGiftCards.reduce(function(s, g) { return s + (g.amount || 0); }, 0);
            var totalBalance = allGiftCards.reduce(function(s, g) { return s + (g.balance || 0); }, 0);
            var activeCount = allGiftCards.filter(function(g) { return g.active && g.balance > 0; }).length;

            summary.innerHTML = '<div class="gc-stats">' +
                '<div class="gc-stat"><span class="gc-stat-num">' + allGiftCards.length + '</span><span class="gc-stat-label">Total Issued</span></div>' +
                '<div class="gc-stat"><span class="gc-stat-num">\u20B9' + totalIssued + '</span><span class="gc-stat-label">Total Value</span></div>' +
                '<div class="gc-stat"><span class="gc-stat-num">\u20B9' + totalBalance + '</span><span class="gc-stat-label">Outstanding Balance</span></div>' +
                '<div class="gc-stat"><span class="gc-stat-num">' + activeCount + '</span><span class="gc-stat-label">Active Cards</span></div>' +
            '</div>';

            container.innerHTML = allGiftCards.map(function(g) {
                var status = !g.active ? 'Deactivated' : g.balance <= 0 ? 'Used' : 'Active';
                var statusClass = !g.active ? 'gc-inactive' : g.balance <= 0 ? 'gc-used' : 'gc-active';
                var date = g.createdAt ? new Date(g.createdAt).toLocaleDateString('en-IN', { day: 'numeric', month: 'short', year: 'numeric' }) : '';
                return '<div class="gc-card">' +
                    '<div class="gc-card-header">' +
                        '<span class="gc-code">' + escHtml(g.code || g.id) + '</span>' +
                        '<span class="gc-status ' + statusClass + '">' + status + '</span>' +
                    '</div>' +
                    '<div class="gc-card-body">' +
                        '<div class="gc-row"><span>Amount:</span><strong>\u20B9' + (g.amount || 0) + '</strong></div>' +
                        '<div class="gc-row"><span>Balance:</span><strong>\u20B9' + (g.balance || 0) + '</strong></div>' +
                        '<div class="gc-row"><span>Buyer:</span><span>' + escHtml(g.purchaserPhone || 'N/A') + '</span></div>' +
                        '<div class="gc-row"><span>Recipient:</span><span>' + escHtml(g.recipientPhone || 'N/A') + '</span></div>' +
                        '<div class="gc-row"><span>Date:</span><span>' + date + '</span></div>' +
                    '</div>' +
                '</div>';
            }).join('');
        }

        // ─── EXPENSES ───
        var allExpenses = [];
        var expensesLoaded = false;
        var expCatFilter = 'all';
        var expMonthFilter = (function() {
            var d = new Date();
            return d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0');
        })();

        var expViewMode = 'card';
        var expDateFrom = '';
        var expDateTo = '';
        var EXP_CATEGORIES = ['Ingredients','Utilities','Staff','Equipment','Rent','Marketing','Other'];

        function loadExpenses() {
            db.collection('expenses').orderBy('date', 'desc').onSnapshot(function(snapshot) {
                allExpenses = [];
                snapshot.forEach(function(doc) { allExpenses.push(Object.assign({ id: doc.id }, doc.data())); });
                expensesLoaded = true;
                renderExpenses();
            }, function(err) { console.error('Expenses load error:', err); });
        }

        function getFilteredExpenses() {
            return allExpenses.filter(function(e) {
                var dateMatch = true;
                if (expMonthFilter) {
                    dateMatch = e.date && e.date.startsWith(expMonthFilter);
                } else {
                    if (expDateFrom) dateMatch = dateMatch && e.date >= expDateFrom;
                    if (expDateTo) dateMatch = dateMatch && e.date <= expDateTo;
                }
                var catMatch = expCatFilter === 'all' || e.category === expCatFilter;
                return dateMatch && catMatch;
            });
        }

        function renderExpenses() {
            renderExpensesSummary();
            var list = document.getElementById('expenses-list');
            var tableWrap = document.getElementById('expenses-table-wrap');
            if (!list) return;
            var filtered = getFilteredExpenses();

            if (expViewMode === 'table') {
                list.style.display = 'none';
                if (tableWrap) tableWrap.style.display = '';
                renderExpensesTable(filtered);
                return;
            }

            list.style.display = '';
            if (tableWrap) tableWrap.style.display = 'none';

            if (filtered.length === 0) {
                list.innerHTML = '<div class="empty-state"><div class="icon">🧾</div><p>No expenses found</p><p class="sub">Click "+ Add Expense" to log your first entry</p></div>';
                return;
            }
            list.innerHTML = filtered.map(function(e) {
                var dateStr = e.date ? new Date(e.date + 'T00:00:00').toLocaleDateString('en-IN', { day: 'numeric', month: 'short', year: 'numeric' }) : '';
                var badgeClass = 'exp-badge exp-badge-' + (e.category || 'Other');
                var billHtml = e.billImageUrl
                    ? '<img class="exp-bill-thumb" src="' + escHtml(e.billImageUrl) + '" alt="Bill" onclick="viewBillImage(\'' + escHtml(e.billImageUrl) + '\')" loading="lazy">'
                    : '<div class="exp-bill-placeholder">🧾</div>';
                return '<div class="expense-card">' +
                    billHtml +
                    '<div class="exp-main">' +
                        '<div class="exp-top">' +
                            '<span class="exp-date">' + dateStr + '</span>' +
                            '<span class="' + badgeClass + '">' + escHtml(e.category || 'Other') + '</span>' +
                            '<span class="exp-amount">\u20B9' + Number(e.amount || 0).toLocaleString('en-IN') + '</span>' +
                        '</div>' +
                        '<div class="exp-desc">' + escHtml(e.description || '') + '</div>' +
                        (e.paidBy ? '<div class="exp-paid-by" style="font-size:0.75rem;color:var(--text-dim);margin-top:0.2rem">Paid by: <strong style="color:var(--cream)">' + escHtml(e.paidBy) + '</strong></div>' : '') +
                    '</div>' +
                    '<div class="exp-actions">' +
                        '<button class="btn-sm btn-outline" onclick="openExpenseModal(\'' + e.id + '\')">Edit</button>' +
                        '<button class="btn-sm btn-danger" onclick="deleteExpense(\'' + e.id + '\',\'' + escHtml(e.description || '') + '\')">Delete</button>' +
                    '</div>' +
                '</div>';
            }).join('');
        }

        function renderExpensesTable(filtered) {
            var wrap = document.getElementById('expenses-table-wrap');
            if (!wrap) return;
            if (filtered.length === 0) {
                wrap.innerHTML = '<div class="empty-state"><div class="icon">🧾</div><p>No expenses found</p></div>';
                return;
            }
            var total = filtered.reduce(function(s, e) { return s + (parseFloat(e.amount) || 0); }, 0);
            var rows = filtered.map(function(e, i) {
                var dateStr = e.date ? new Date(e.date + 'T00:00:00').toLocaleDateString('en-IN', { day: 'numeric', month: 'short', year: 'numeric' }) : '';
                var badgeClass = 'exp-badge exp-badge-' + (e.category || 'Other');
                return '<tr>' +
                    '<td>' + (i + 1) + '</td>' +
                    '<td class="exp-date-cell">' + dateStr + '</td>' +
                    '<td><span class="' + badgeClass + '">' + escHtml(e.category || 'Other') + '</span></td>' +
                    '<td class="exp-desc-cell" title="' + escHtml(e.description || '') + '">' + escHtml(e.description || '') + '</td>' +
                    '<td style="white-space:nowrap">' + escHtml(e.paidBy || '-') + '</td>' +
                    '<td class="exp-amount-cell">\u20B9' + Number(e.amount || 0).toLocaleString('en-IN') + '</td>' +
                    '<td><div class="exp-actions-cell">' +
                        '<button class="btn-sm btn-outline" onclick="openExpenseModal(\'' + e.id + '\')">Edit</button>' +
                        '<button class="btn-sm btn-danger" onclick="deleteExpense(\'' + e.id + '\',\'' + escHtml(e.description || '') + '\')">Del</button>' +
                    '</div></td>' +
                '</tr>';
            }).join('');
            wrap.innerHTML = '<table class="exp-table">' +
                '<thead><tr><th>#</th><th>Date</th><th>Category</th><th>Description</th><th>Paid By</th><th>Amount</th><th>Actions</th></tr></thead>' +
                '<tbody>' + rows + '</tbody>' +
                '<tfoot><tr><td colspan="5" style="text-align:right;">Total (' + filtered.length + ' entries)</td><td class="exp-amount-cell">\u20B9' + Number(total).toLocaleString('en-IN') + '</td><td></td></tr></tfoot>' +
            '</table>';
        }

        function toggleExpView(mode) {
            expViewMode = mode;
            var btns = document.querySelectorAll('#exp-view-toggle button');
            btns.forEach(function(b) { b.classList.remove('active'); });
            if (mode === 'card') btns[0].classList.add('active');
            else btns[1].classList.add('active');
            renderExpenses();
        }

        function downloadExpensesExcel() {
            if (typeof XLSX === 'undefined') { alert('Excel library not loaded. Please refresh and try again.'); return; }
            var filtered = getFilteredExpenses();
            if (filtered.length === 0) { alert('No expenses to download.'); return; }
            var data = filtered.map(function(e) {
                return {
                    'Date': e.date || '',
                    'Category': e.category || 'Other',
                    'Description': e.description || '',
                    'Paid By': e.paidBy || '',
                    'Amount': parseFloat(e.amount) || 0
                };
            });
            var total = filtered.reduce(function(s, e) { return s + (parseFloat(e.amount) || 0); }, 0);
            data.push({ 'Date': '', 'Category': '', 'Description': 'TOTAL', 'Paid By': '', 'Amount': total });
            var ws = XLSX.utils.json_to_sheet(data);
            ws['!cols'] = [{ wch: 12 }, { wch: 14 }, { wch: 40 }, { wch: 16 }, { wch: 12 }];
            var wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Expenses');
            var label = expMonthFilter || (expDateFrom || expDateTo ? (expDateFrom || '') + '_to_' + (expDateTo || '') : 'All');
            var filename = 'Amogha_Expenses_' + label + '.xlsx';
            XLSX.writeFile(wb, filename);
        }

        function renderExpensesSummary() {
            var el = document.getElementById('expenses-summary');
            if (!el) return;
            var summaryExpenses = getFilteredExpenses();
            var total = summaryExpenses.reduce(function(s, e) { return s + (parseFloat(e.amount) || 0); }, 0);
            var byCategory = {};
            EXP_CATEGORIES.forEach(function(c) { byCategory[c] = 0; });
            summaryExpenses.forEach(function(e) {
                var cat = e.category || 'Other';
                byCategory[cat] = (byCategory[cat] || 0) + (parseFloat(e.amount) || 0);
            });
            var label;
            if (expMonthFilter) {
                label = new Date(expMonthFilter + '-01').toLocaleDateString('en-IN', { month: 'long', year: 'numeric' });
            } else if (expDateFrom || expDateTo) {
                label = (expDateFrom || '...') + ' to ' + (expDateTo || '...');
            } else {
                label = 'All Time';
            }
            var breakdown = EXP_CATEGORIES.filter(function(c) { return byCategory[c] > 0; }).map(function(c) {
                return '<span><strong>' + c + '</strong> \u20B9' + Number(byCategory[c]).toLocaleString('en-IN') + '</span>';
            }).join('');
            el.innerHTML = '<div class="expenses-summary-strip">' +
                '<div class="exp-total">' + label + ' \u2014 Total: \u20B9' + Number(total).toLocaleString('en-IN') + '</div>' +
                (breakdown ? '<div class="exp-breakdown">' + breakdown + '</div>' : '') +
            '</div>';
        }

        function openExpenseModal(id) {
            var modal = document.getElementById('expense-modal');
            var title = document.getElementById('expense-modal-title');
            var editId = document.getElementById('expense-edit-id');
            var billUrl = document.getElementById('expense-pending-bill-url');
            var preview = document.getElementById('exp-bill-preview');
            var billStatus = document.getElementById('exp-bill-status');
            var msg = document.getElementById('exp-modal-msg');
            if (msg) msg.textContent = '';
            if (billStatus) billStatus.textContent = '';
            if (billUrl) billUrl.value = '';
            if (preview) { preview.src = ''; preview.style.display = 'none'; }
            var scanBtn = document.getElementById('exp-scan-btn');
            var ocrStatus = document.getElementById('exp-ocr-status');
            var pdfIndicator = document.getElementById('exp-pdf-indicator');
            if (scanBtn) { scanBtn.style.display = 'none'; scanBtn.disabled = false; scanBtn.textContent = '🔍 Scan Bill & Auto-fill'; }
            if (ocrStatus) ocrStatus.textContent = '';
            if (pdfIndicator) pdfIndicator.style.display = 'none';
            pendingBillFile = null;

            if (id) {
                var exp = allExpenses.find(function(e) { return e.id === id; });
                if (!exp) return;
                title.textContent = 'Edit Expense';
                editId.value = id;
                document.getElementById('exp-date').value = exp.date || '';
                document.getElementById('exp-category').value = exp.category || '';
                document.getElementById('exp-amount').value = exp.amount || '';
                document.getElementById('exp-description').value = exp.description || '';
                document.getElementById('exp-paid-by').value = exp.paidBy || '';
                if (exp.billImageUrl) {
                    if (billUrl) billUrl.value = exp.billImageUrl;
                    if (preview) { preview.src = exp.billImageUrl; preview.style.display = 'block'; }
                }
            } else {
                title.textContent = 'Add Expense';
                editId.value = '';
                document.getElementById('exp-date').value = new Date().toISOString().slice(0,10);
                document.getElementById('exp-category').value = '';
                document.getElementById('exp-amount').value = '';
                document.getElementById('exp-description').value = '';
                document.getElementById('exp-paid-by').value = '';
            }
            modal.style.display = 'block';
        }

        function closeExpenseModal() {
            document.getElementById('expense-modal').style.display = 'none';
            var input = document.getElementById('exp-bill-input');
            if (input) input.value = '';
            pendingBillFile = null;
            var scanBtn = document.getElementById('exp-scan-btn');
            if (scanBtn) { scanBtn.style.display = 'none'; scanBtn.disabled = false; scanBtn.textContent = '🔍 Scan Bill & Auto-fill'; }
        }

        function saveExpense() {
            var editId = document.getElementById('expense-edit-id').value.trim();
            var date = document.getElementById('exp-date').value.trim();
            var category = document.getElementById('exp-category').value;
            var amount = parseFloat(document.getElementById('exp-amount').value);
            var description = document.getElementById('exp-description').value.trim();
            var paidBy = document.getElementById('exp-paid-by').value.trim();
            var billUrl = (document.getElementById('expense-pending-bill-url').value || '').trim();
            var msg = document.getElementById('exp-modal-msg');

            if (!date) { msg.textContent = 'Please select a date.'; msg.style.color = '#e74c3c'; return; }
            if (!category) { msg.textContent = 'Please select a category.'; msg.style.color = '#e74c3c'; return; }
            if (!amount || amount <= 0) { msg.textContent = 'Please enter a valid amount.'; msg.style.color = '#e74c3c'; return; }
            if (!description) { msg.textContent = 'Please add a description.'; msg.style.color = '#e74c3c'; return; }

            msg.textContent = 'Saving…'; msg.style.color = 'var(--text-dim)';

            var data = { date: date, category: category, amount: amount, description: description, paidBy: paidBy };
            if (billUrl) data.billImageUrl = billUrl;

            var promise;
            if (editId) {
                promise = db.collection('expenses').doc(editId).update(data);
            } else {
                data.createdAt = new Date().toISOString();
                promise = db.collection('expenses').add(data);
            }
            promise.then(function() {
                closeExpenseModal();
            }).catch(function(err) {
                console.error('Save expense error:', err);
                msg.textContent = 'Error saving. Try again.'; msg.style.color = '#e74c3c';
            });
        }

        function deleteExpense(id, desc) {
            if (!confirm('Delete expense "' + desc + '"?')) return;
            db.collection('expenses').doc(id).delete().catch(function(err) {
                console.error('Delete expense error:', err);
                alert('Could not delete. Try again.');
            });
        }

        var pendingBillFile = null;

        function handleExpBillSelect() {
            var file = document.getElementById('exp-bill-input').files[0];
            if (!file) return;

            var isImage = ACCEPTED_TYPES.includes(file.type);
            var isPdf = file.type === 'application/pdf';

            if (!isImage && !isPdf) { alert('Please select a JPG, PNG, WebP image or a PDF.'); return; }
            if (file.size > MAX_IMAGE_SIZE) { alert('File must be under 2MB.'); return; }

            pendingBillFile = file;

            var statusEl = document.getElementById('exp-bill-status');
            var preview = document.getElementById('exp-bill-preview');
            var pdfIndicator = document.getElementById('exp-pdf-indicator');
            var scanBtn = document.getElementById('exp-scan-btn');
            var ocrStatus = document.getElementById('exp-ocr-status');

            if (preview) { preview.src = ''; preview.style.display = 'none'; }
            if (pdfIndicator) pdfIndicator.style.display = 'none';
            if (ocrStatus) ocrStatus.textContent = '';
            if (scanBtn) scanBtn.style.display = 'block';

            if (isPdf) {
                if (pdfIndicator) { pdfIndicator.textContent = '📄 ' + file.name; pdfIndicator.style.display = 'block'; }
                statusEl.textContent = 'PDF selected. Click "Scan Bill" to auto-extract details.';
            } else {
                statusEl.textContent = 'Uploading...';
                var formData = new FormData();
                formData.append('file', file);
                formData.append('upload_preset', CLOUDINARY_PRESET);
                formData.append('public_id', 'expense_bill_' + Date.now());

                var xhr = new XMLHttpRequest();
                xhr.open('POST', CLOUDINARY_URL);
                xhr.upload.onprogress = function(e) {
                    if (e.lengthComputable) statusEl.textContent = 'Uploading ' + Math.round((e.loaded / e.total) * 100) + '%...';
                };
                xhr.onerror = function() { statusEl.textContent = 'Upload failed. Try again.'; };
                xhr.onload = function() {
                    if (xhr.status !== 200) { statusEl.textContent = 'Upload failed. Try again.'; return; }
                    var res = JSON.parse(xhr.responseText);
                    var url = res.secure_url;
                    document.getElementById('expense-pending-bill-url').value = url;
                    preview.src = url;
                    preview.style.display = 'block';
                    statusEl.textContent = 'Uploaded! Click "Scan Bill" to auto-extract details.';
                };
                xhr.send(formData);
            }
        }

        function scanBillOCR() {
            if (!pendingBillFile) { alert('Please select a bill image or PDF first.'); return; }

            var scanBtn = document.getElementById('exp-scan-btn');
            var ocrStatus = document.getElementById('exp-ocr-status');

            scanBtn.disabled = true;
            scanBtn.textContent = '⏳ Scanning...';
            ocrStatus.textContent = 'Analyzing bill with AI...';
            ocrStatus.style.color = 'var(--text-dim)';

            var reader = new FileReader();
            reader.onload = function(e) {
                var base64Data = e.target.result.split(',')[1];
                var mimeType = pendingBillFile.type;

                var xhr = new XMLHttpRequest();
                xhr.open('POST', '/api/parse-bill');
                xhr.setRequestHeader('Content-Type', 'application/json');
                xhr.timeout = 30000;

                xhr.onerror = function() {
                    ocrStatus.textContent = 'Network error. Please try again.';
                    ocrStatus.style.color = '#f44336';
                    scanBtn.disabled = false;
                    scanBtn.textContent = '🔍 Scan Bill & Auto-fill';
                };

                xhr.ontimeout = function() {
                    ocrStatus.textContent = 'Scan timed out. Please try again or enter details manually.';
                    ocrStatus.style.color = '#f44336';
                    scanBtn.disabled = false;
                    scanBtn.textContent = '🔍 Scan Bill & Auto-fill';
                };

                xhr.onload = function() {
                    scanBtn.disabled = false;
                    scanBtn.textContent = '🔍 Scan Bill & Auto-fill';

                    if (xhr.status !== 200) {
                        var errMsg = 'Scan failed.';
                        try { errMsg = JSON.parse(xhr.responseText).error || errMsg; } catch(ignored) {}
                        ocrStatus.textContent = errMsg;
                        ocrStatus.style.color = '#f44336';
                        return;
                    }

                    var res = JSON.parse(xhr.responseText);
                    if (!res.success || !res.extracted) {
                        ocrStatus.textContent = 'Could not extract data. Please enter details manually.';
                        ocrStatus.style.color = '#f44336';
                        return;
                    }

                    var data = res.extracted;
                    if (data.amount && data.amount > 0) document.getElementById('exp-amount').value = data.amount;
                    if (data.date) document.getElementById('exp-date').value = data.date;
                    if (data.description) document.getElementById('exp-description').value = data.description;
                    if (data.category) document.getElementById('exp-category').value = data.category;
                    if (data.paidBy) document.getElementById('exp-paid-by').value = data.paidBy;

                    var confClass = 'exp-ocr-confidence-' + (data.confidence || 'low');
                    var confLabel = data.confidence === 'high' ? 'High confidence' : data.confidence === 'medium' ? 'Medium confidence' : 'Low confidence';
                    ocrStatus.innerHTML = '✅ Bill scanned! <span class="' + confClass + '">(' + confLabel + ')</span> — Please review before saving.';
                };

                xhr.send(JSON.stringify({ fileData: base64Data, mimeType: mimeType }));
            };

            reader.onerror = function() {
                ocrStatus.textContent = 'Could not read file. Please try again.';
                ocrStatus.style.color = '#f44336';
                scanBtn.disabled = false;
                scanBtn.textContent = '🔍 Scan Bill & Auto-fill';
            };

            reader.readAsDataURL(pendingBillFile);
        }

        function viewBillImage(url) {
            var overlay = document.createElement('div');
            overlay.className = 'exp-img-overlay';
            overlay.innerHTML = '<img src="' + escHtml(url) + '" alt="Bill">';
            overlay.onclick = function() { document.body.removeChild(overlay); };
            document.body.appendChild(overlay);
        }

        // ─── INVENTORY / STOCK ───
        function saveStock(itemId) {
            var key = itemId.replace(/[^a-zA-Z0-9]/g, '_');
            var input = document.getElementById('stock-' + key);
            var val = input.value.trim();
            var stock = val === '' ? null : parseInt(val);
            var update = { stock: stock, updatedAt: new Date().toISOString() };
            if (stock === 0) update.available = false;
            db.collection('menu').doc(itemId).update(update).catch(function(err) { console.error('Save stock error:', err); });
        }

        // ─── PRINT ORDER ───
        function printOrder(orderId) {
            var order = allOrders.find(function(o) { return o.id === orderId; });
            if (!order) return;
            var date = order.createdAt ? new Date(order.createdAt).toLocaleString('en-IN') : '';
            var itemsHtml = (order.items || []).map(function(item) {
                return '<tr><td>' + escHtml(item.name) + '</td><td style="text-align:center">x' + item.qty + '</td><td style="text-align:right">\u20B9' + (item.price * item.qty) + '</td></tr>';
            }).join('');
            var win = window.open('', '_blank', 'width=400,height=600');
            win.document.write('<!DOCTYPE html><html><head><title>Order Receipt</title><style>' +
                'body{font-family:monospace;max-width:380px;margin:0 auto;padding:20px;color:#000}' +
                'h1{text-align:center;font-size:18px;margin:0 0 4px}' +
                '.sub{text-align:center;font-size:11px;color:#666;margin-bottom:16px}' +
                'hr{border:none;border-top:1px dashed #999;margin:10px 0}' +
                'table{width:100%;border-collapse:collapse;font-size:13px}td{padding:3px 0}' +
                '.total{font-weight:bold;font-size:15px;text-align:right;margin-top:8px}' +
                '.info{font-size:11px;color:#555;margin:4px 0}' +
                '@media print{body{margin:0;padding:10px}}' +
                '</style></head><body>' +
                '<h1>Amogha Cafe & Restaurant</h1>' +
                '<div class="sub">Order Receipt</div><hr>' +
                '<div class="info">Order: #' + orderId.slice(-6).toUpperCase() + '</div>' +
                '<div class="info">Date: ' + date + '</div>' +
                '<div class="info">Customer: ' + escHtml(order.customer || 'Walk-in') + '</div>' +
                '<div class="info">Phone: ' + escHtml(order.phone || '-') + '</div>' +
                (order.address ? '<div class="info">Address: ' + escHtml(order.address) + '</div>' : '') +
                '<hr><table>' + itemsHtml + '</table><hr>' +
                '<div class="total">Total: \u20B9' + (order.total || 0) + '</div>' +
                '<div class="info">Payment: ' + escHtml(order.payment || 'N/A') + ' | Status: ' + escHtml(order.status || 'pending') + '</div>' +
                '<hr><div style="text-align:center;font-size:10px;color:#888;margin-top:12px">Thank you for choosing Amogha!</div>' +
                '</body></html>');
            win.document.close();
            setTimeout(function() { win.print(); }, 300);
        }

        // ─── EXPORT CSV ───
        function exportOrdersCSV() {
            var filtered = currentFilter === 'all' ? allOrders : allOrders.filter(function(o) { return o.status === currentFilter; });
            if (filtered.length === 0) { alert('No orders to export'); return; }
            var rows = [['Order ID','Date','Customer','Phone','Address','Items','Subtotal','Delivery Fee','Total','Payment','Status']];
            filtered.forEach(function(o) {
                var items = (o.items || []).map(function(i) { return i.name + ' x' + i.qty; }).join('; ');
                rows.push([
                    o.id, o.createdAt || '', o.customer || '', o.phone || '', (o.address || '').replace(/,/g, ' '),
                    items, o.subtotal || '', o.deliveryFee || '', o.total || '', o.payment || '', o.status || ''
                ]);
            });
            var csv = rows.map(function(r) { return r.map(function(c) { return '"' + String(c).replace(/"/g, '""') + '"'; }).join(','); }).join('\n');
            var blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            var url = URL.createObjectURL(blob);
            var a = document.createElement('a');
            a.href = url; a.download = 'amogha-orders-' + new Date().toISOString().split('T')[0] + '.csv';
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // ─── ANALYTICS ───
        var analyticsLoaded = false;

        function loadAnalytics() {
            analyticsLoaded = true;
            renderAnalytics();
        }

        function renderAnalytics() {
            var range = parseInt(document.getElementById('analytics-range').value);
            var now = new Date();
            var filtered = allOrders;
            if (range > 0) {
                var cutoff = new Date(now.getTime() - range * 24 * 60 * 60 * 1000).toISOString();
                filtered = allOrders.filter(function(o) { return o.createdAt && o.createdAt >= cutoff; });
            }
            var active = filtered.filter(function(o) { return o.status !== 'cancelled'; });

            // Summary cards
            var totalRevenue = active.reduce(function(s, o) { return s + (o.total || 0); }, 0);
            var avgOrder = active.length ? Math.round(totalRevenue / active.length) : 0;
            var uniqueCustomers = new Set(filtered.map(function(o) { return o.phone; }).filter(Boolean)).size;
            var repeatPhones = {};
            filtered.forEach(function(o) { if (o.phone) repeatPhones[o.phone] = (repeatPhones[o.phone] || 0) + 1; });
            var repeatCustomers = Object.values(repeatPhones).filter(function(c) { return c > 1; }).length;

            document.getElementById('analytics-summary').innerHTML =
                '<div class="an-card"><div class="an-val">\u20B9' + totalRevenue.toLocaleString('en-IN') + '</div><div class="an-label">Revenue</div></div>' +
                '<div class="an-card"><div class="an-val">' + active.length + '</div><div class="an-label">Orders</div></div>' +
                '<div class="an-card"><div class="an-val">\u20B9' + avgOrder + '</div><div class="an-label">Avg Order</div></div>' +
                '<div class="an-card"><div class="an-val">' + uniqueCustomers + ' <small>(' + repeatCustomers + ' repeat)</small></div><div class="an-label">Customers</div></div>';

            // Revenue chart
            drawRevenueChart(active, range);

            // Top items
            var itemCounts = {};
            active.forEach(function(o) {
                (o.items || []).forEach(function(it) {
                    if (!itemCounts[it.name]) itemCounts[it.name] = { qty: 0, revenue: 0 };
                    itemCounts[it.name].qty += parseInt(it.qty) || 1;
                    itemCounts[it.name].revenue += (it.price * (parseInt(it.qty) || 1));
                });
            });
            var topItems = Object.keys(itemCounts).map(function(n) { return { name: n, qty: itemCounts[n].qty, revenue: itemCounts[n].revenue }; })
                .sort(function(a, b) { return b.qty - a.qty; }).slice(0, 10);
            var maxQty = topItems.length ? topItems[0].qty : 1;
            document.getElementById('top-items-list').innerHTML = topItems.map(function(it, i) {
                var pct = Math.round(it.qty / maxQty * 100);
                return '<div class="top-item"><span class="top-rank">#' + (i + 1) + '</span><span class="top-name">' + escHtml(it.name) + '</span>' +
                    '<div class="top-bar"><div class="top-bar-fill" style="width:' + pct + '%"></div></div>' +
                    '<span class="top-qty">' + it.qty + ' sold</span><span class="top-rev">\u20B9' + it.revenue + '</span></div>';
            }).join('') || '<div class="empty-state"><p>No item data</p></div>';

            // Peak hours
            var hourCounts = new Array(24).fill(0);
            filtered.forEach(function(o) {
                if (o.createdAt) {
                    var h = new Date(o.createdAt).getHours();
                    hourCounts[h]++;
                }
            });
            var maxHour = Math.max.apply(null, hourCounts) || 1;
            document.getElementById('peak-hours-grid').innerHTML = hourCounts.map(function(c, h) {
                var intensity = Math.round(c / maxHour * 100);
                var label = h < 10 ? '0' + h : h;
                return '<div class="peak-cell" title="' + label + ':00 - ' + c + ' orders" style="background:rgba(212,160,23,' + (0.05 + intensity * 0.009) + ')">' +
                    '<span class="peak-h">' + label + '</span><span class="peak-c">' + c + '</span></div>';
            }).join('');

            // Status breakdown
            var statusCounts = { pending: 0, confirmed: 0, preparing: 0, delivered: 0, cancelled: 0 };
            filtered.forEach(function(o) { if (statusCounts.hasOwnProperty(o.status)) statusCounts[o.status]++; });
            var total = filtered.length || 1;
            document.getElementById('status-breakdown').innerHTML = Object.keys(statusCounts).map(function(s) {
                var pct = Math.round(statusCounts[s] / total * 100);
                return '<div class="sb-row"><span class="sb-label status-' + s + '">' + s + '</span><div class="sb-bar"><div class="sb-fill status-bg-' + s + '" style="width:' + pct + '%"></div></div><span class="sb-val">' + statusCounts[s] + ' (' + pct + '%)</span></div>';
            }).join('');
        }

        function drawRevenueChart(orders, range) {
            var canvas = document.getElementById('revenue-chart');
            if (!canvas) return;
            var ctx = canvas.getContext('2d');
            var w = canvas.parentElement.clientWidth - 20;
            canvas.width = w; canvas.height = 220;
            ctx.clearRect(0, 0, w, 220);

            // Group by date
            var dailyRevenue = {};
            orders.forEach(function(o) {
                if (o.createdAt) {
                    var d = o.createdAt.split('T')[0];
                    dailyRevenue[d] = (dailyRevenue[d] || 0) + (o.total || 0);
                }
            });

            var days = Object.keys(dailyRevenue).sort();
            if (days.length === 0) { ctx.fillStyle = '#6a5a4a'; ctx.font = '14px Poppins'; ctx.fillText('No data', w / 2 - 30, 110); return; }
            var vals = days.map(function(d) { return dailyRevenue[d]; });
            var maxVal = Math.max.apply(null, vals) || 1;
            var barW = Math.min(40, (w - 60) / days.length - 4);
            var chartH = 170;
            var startX = 50;

            // Y axis
            ctx.strokeStyle = 'rgba(212,160,23,0.1)'; ctx.lineWidth = 1;
            for (var g = 0; g <= 4; g++) {
                var gy = 20 + (chartH / 4) * g;
                ctx.beginPath(); ctx.moveTo(startX, gy); ctx.lineTo(w, gy); ctx.stroke();
                ctx.fillStyle = '#6a5a4a'; ctx.font = '10px Poppins'; ctx.textAlign = 'right';
                ctx.fillText('\u20B9' + Math.round(maxVal - (maxVal / 4) * g), startX - 6, gy + 4);
            }

            // Bars
            days.forEach(function(day, i) {
                var x = startX + i * ((w - startX - 10) / days.length) + 2;
                var h = (vals[i] / maxVal) * chartH;
                var y = 20 + chartH - h;

                var grad = ctx.createLinearGradient(x, y, x, 20 + chartH);
                grad.addColorStop(0, '#D4A017'); grad.addColorStop(1, 'rgba(212,160,23,0.2)');
                ctx.fillStyle = grad;
                ctx.beginPath(); ctx.roundRect(x, y, barW, h, [4, 4, 0, 0]); ctx.fill();

                // Date label
                ctx.fillStyle = '#6a5a4a'; ctx.font = '9px Poppins'; ctx.textAlign = 'center';
                ctx.fillText(day.slice(5), x + barW / 2, 20 + chartH + 14);
            });
        }

        // ─── COUPON MANAGEMENT ───
        var allCoupons = [];

        function loadCoupons() {
            db.collection('coupons').onSnapshot(function(snapshot) {
                allCoupons = [];
                snapshot.forEach(function(doc) { allCoupons.push({ id: doc.id, ...doc.data() }); });
                renderCouponsAdmin();
            }, function(err) { console.error('Coupons error:', err); });
        }

        function renderCouponsAdmin() {
            var container = document.getElementById('coupons-admin-grid');
            if (allCoupons.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="icon">🎟️</div><p>No coupons yet</p><p class="sub">Click "+ Add Coupon" to create promo codes</p></div>';
                return;
            }
            container.innerHTML = allCoupons.map(function(c) {
                var checked = c.active ? ' checked' : '';
                var expired = c.expiresAt && new Date(c.expiresAt) < new Date();
                var expClass = expired ? ' coupon-expired' : '';
                return '<div class="coupon-card' + expClass + '">' +
                    '<div class="coupon-top">' +
                        '<span class="coupon-code">' + escHtml(c.code || c.id) + '</span>' +
                        '<label class="toggle-switch"><input type="checkbox"' + checked + ' onchange="toggleCouponActive(\'' + escHtml(c.id) + '\', this.checked)"><span class="toggle-slider"></span></label>' +
                    '</div>' +
                    '<div class="coupon-details">' +
                        '<span class="coupon-discount">' + c.discount + (c.type === 'percent' ? '%' : ' flat') + ' off</span>' +
                        '<span class="coupon-label">' + escHtml(c.label || '') + '</span>' +
                    '</div>' +
                    '<div class="coupon-meta">' +
                        (c.minOrder ? '<span>Min: \u20B9' + c.minOrder + '</span>' : '') +
                        (c.maxDiscount ? '<span>Max: \u20B9' + c.maxDiscount + '</span>' : '') +
                        '<span>Used: ' + (c.usedCount || 0) + (c.usageLimit ? '/' + c.usageLimit : '') + '</span>' +
                        (c.expiresAt ? '<span>Exp: ' + c.expiresAt.split('T')[0] + '</span>' : '') +
                    '</div>' +
                    '<button class="mac-remove-btn" onclick="removeCoupon(\'' + escHtml(c.id) + '\')" title="Delete coupon">✕</button>' +
                '</div>';
            }).join('');
        }

        function showAddCoupon() { document.getElementById('add-coupon-modal').style.display = 'flex'; }
        function hideAddCoupon() { document.getElementById('add-coupon-modal').style.display = 'none'; }

        function addCoupon() {
            var code = document.getElementById('coupon-code-input').value.trim().toUpperCase();
            var discount = parseInt(document.getElementById('coupon-discount').value);
            var type = document.getElementById('coupon-type').value;
            var label = document.getElementById('coupon-label').value.trim();
            var minOrder = parseInt(document.getElementById('coupon-min-order').value) || 0;
            var maxDiscount = parseInt(document.getElementById('coupon-max-discount').value) || 0;
            var usageLimit = parseInt(document.getElementById('coupon-usage-limit').value) || 0;
            var expires = document.getElementById('coupon-expires').value;

            if (!code || !discount) { alert('Code and discount are required'); return; }
            if (!label) label = discount + (type === 'percent' ? '% off' : ' flat off');

            db.collection('coupons').doc(code).set({
                code: code, discount: discount, type: type, label: label,
                active: true, minOrder: minOrder, maxDiscount: maxDiscount,
                usageLimit: usageLimit, usedCount: 0,
                expiresAt: expires ? new Date(expires).toISOString() : null,
                createdAt: new Date().toISOString()
            }).then(function() {
                hideAddCoupon();
                ['coupon-code-input','coupon-discount','coupon-label','coupon-min-order','coupon-max-discount','coupon-usage-limit','coupon-expires']
                    .forEach(function(id) { document.getElementById(id).value = ''; });
            }).catch(function(err) { alert('Error: ' + err.message); });
        }

        function toggleCouponActive(id, active) {
            db.collection('coupons').doc(id).update({ active: active });
        }

        function removeCoupon(id) {
            if (!confirm('Delete this coupon?')) return;
            db.collection('coupons').doc(id).delete();
        }

        // ─── REVIEW MANAGEMENT ───
        var allReviews = [];

        function loadReviews() {
            db.collection('reviews').orderBy('createdAt', 'desc').get().then(function(snapshot) {
                allReviews = [];
                snapshot.forEach(function(doc) { allReviews.push({ id: doc.id, ...doc.data() }); });
                renderReviewsAdmin();
            }).catch(function(err) { console.error('Reviews error:', err); });
        }

        function renderReviewsAdmin() {
            var sort = document.getElementById('review-sort').value;
            var sorted = allReviews.slice();
            if (sort === 'oldest') sorted.sort(function(a, b) { return (a.createdAt || '').localeCompare(b.createdAt || ''); });
            else if (sort === 'highest') sorted.sort(function(a, b) { return (b.rating || 0) - (a.rating || 0); });
            else if (sort === 'lowest') sorted.sort(function(a, b) { return (a.rating || 0) - (b.rating || 0); });

            // Summary
            var itemRatings = {};
            allReviews.forEach(function(r) {
                if (!itemRatings[r.itemName]) itemRatings[r.itemName] = { total: 0, count: 0 };
                itemRatings[r.itemName].total += (r.rating || 0);
                itemRatings[r.itemName].count++;
            });
            var avgOverall = allReviews.length ? (allReviews.reduce(function(s, r) { return s + (r.rating || 0); }, 0) / allReviews.length).toFixed(1) : '0';
            document.getElementById('review-summary').innerHTML =
                '<div class="rv-stat"><span class="rv-big">' + avgOverall + '</span><span class="rv-stars">' + getStarsHtml(parseFloat(avgOverall)) + '</span><span class="rv-count">' + allReviews.length + ' reviews</span></div>';

            // Cards
            var container = document.getElementById('reviews-admin-grid');
            if (sorted.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="icon">⭐</div><p>No reviews yet</p></div>';
                return;
            }
            container.innerHTML = sorted.map(function(r) {
                var date = r.createdAt ? new Date(r.createdAt).toLocaleDateString('en-IN', { day: 'numeric', month: 'short', year: 'numeric' }) : '';
                return '<div class="rv-card">' +
                    '<div class="rv-top"><span class="rv-item">' + escHtml(r.itemName || 'Unknown') + '</span><span class="rv-date">' + date + '</span></div>' +
                    '<div class="rv-rating">' + getStarsHtml(r.rating || 0) + ' <span>' + (r.rating || 0) + '/5</span></div>' +
                    (r.text ? '<div class="rv-text">"' + escHtml(r.text) + '"</div>' : '') +
                    '<div class="rv-author">— ' + escHtml(r.userName || 'Anonymous') + '</div>' +
                '</div>';
            }).join('');
        }

        function getStarsHtml(rating) {
            var html = '';
            for (var i = 1; i <= 5; i++) {
                if (i <= Math.floor(rating)) html += '<span class="star-full">★</span>';
                else if (i - 0.5 <= rating) html += '<span class="star-half">★</span>';
                else html += '<span class="star-empty">★</span>';
            }
            return html;
        }

        // ─── CUSTOMER CRM ───
        var crmCustomers = [];

        function loadCRM() {
            db.collection('users').get().then(function(userSnap) {
                var usersMap = {};
                userSnap.forEach(function(doc) {
                    var d = doc.data();
                    usersMap[doc.id] = { phone: doc.id, name: d.name || 'Unknown', loyaltyPoints: d.loyaltyPoints || 0, orderCount: 0, totalSpent: 0, lastOrder: null };
                });
                // Aggregate from orders
                allOrders.forEach(function(o) {
                    var phone = o.phone || o.userId;
                    if (phone && usersMap[phone]) {
                        usersMap[phone].orderCount++;
                        if (o.status !== 'cancelled') usersMap[phone].totalSpent += (o.total || 0);
                        if (!usersMap[phone].lastOrder || (o.createdAt && o.createdAt > usersMap[phone].lastOrder)) {
                            usersMap[phone].lastOrder = o.createdAt;
                        }
                    }
                });
                crmCustomers = Object.values(usersMap);
                renderCRM();
            }).catch(function(err) { console.error('CRM error:', err); });
        }

        function renderCRM() {
            var sort = document.getElementById('crm-sort').value;
            var sorted = crmCustomers.slice();
            if (sort === 'spent') sorted.sort(function(a, b) { return b.totalSpent - a.totalSpent; });
            else if (sort === 'orders') sorted.sort(function(a, b) { return b.orderCount - a.orderCount; });
            else if (sort === 'recent') sorted.sort(function(a, b) { return (b.lastOrder || '').localeCompare(a.lastOrder || ''); });

            // Summary
            var totalCustomers = crmCustomers.length;
            var withOrders = crmCustomers.filter(function(c) { return c.orderCount > 0; }).length;
            var totalRevenue = crmCustomers.reduce(function(s, c) { return s + c.totalSpent; }, 0);
            document.getElementById('crm-summary').innerHTML =
                '<div class="an-card"><div class="an-val">' + totalCustomers + '</div><div class="an-label">Total Customers</div></div>' +
                '<div class="an-card"><div class="an-val">' + withOrders + '</div><div class="an-label">Active (ordered)</div></div>' +
                '<div class="an-card"><div class="an-val">\u20B9' + totalRevenue.toLocaleString('en-IN') + '</div><div class="an-label">Total Revenue</div></div>';

            // Customer cards
            var container = document.getElementById('crm-grid');
            if (sorted.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="icon">👥</div><p>No customers found</p></div>';
                return;
            }
            container.innerHTML = sorted.map(function(c) {
                var tier = c.loyaltyPoints >= 1000 ? 'Gold' : c.loyaltyPoints >= 500 ? 'Silver' : 'Bronze';
                var tierIcon = tier === 'Gold' ? '🥇' : tier === 'Silver' ? '🥈' : '🥉';
                var lastDate = c.lastOrder ? new Date(c.lastOrder).toLocaleDateString('en-IN', { day: 'numeric', month: 'short' }) : 'Never';
                return '<div class="crm-card" onclick="toggleCrmDetail(this)">' +
                    '<div class="crm-top">' +
                        '<div class="crm-avatar">' + (c.name || 'U').charAt(0).toUpperCase() + '</div>' +
                        '<div class="crm-info"><span class="crm-name">' + escHtml(c.name) + '</span><span class="crm-phone">' + escHtml(c.phone) + '</span></div>' +
                        '<span class="crm-tier">' + tierIcon + ' ' + tier + '</span>' +
                    '</div>' +
                    '<div class="crm-stats">' +
                        '<span>' + c.orderCount + ' orders</span>' +
                        '<span>\u20B9' + c.totalSpent.toLocaleString('en-IN') + ' spent</span>' +
                        '<span>Last: ' + lastDate + '</span>' +
                        '<span>' + c.loyaltyPoints + ' pts</span>' +
                    '</div>' +
                    '<div class="crm-detail" style="display:none">' + getCrmOrderHistory(c.phone) + '</div>' +
                '</div>';
            }).join('');
        }

        function toggleCrmDetail(card) {
            var detail = card.querySelector('.crm-detail');
            detail.style.display = detail.style.display === 'none' ? 'block' : 'none';
        }

        function getCrmOrderHistory(phone) {
            var orders = allOrders.filter(function(o) { return o.phone === phone || o.userId === phone; }).slice(0, 5);
            if (orders.length === 0) return '<div class="crm-no-orders">No order history</div>';
            return '<div class="crm-orders">' + orders.map(function(o) {
                var date = o.createdAt ? new Date(o.createdAt).toLocaleDateString('en-IN', { day: 'numeric', month: 'short' }) : '';
                var items = (o.items || []).map(function(i) { return i.name; }).join(', ');
                return '<div class="crm-order-row"><span class="crm-order-date">' + date + '</span><span class="crm-order-items">' + escHtml(items) + '</span><span class="crm-order-total">\u20B9' + (o.total || 0) + '</span><span class="order-status status-' + (o.status || 'pending') + '">' + (o.status || 'pending') + '</span></div>';
            }).join('') + '</div>';
        }
        // ===== DAILY SPECIAL ADMIN =====
        function loadDailySpecialAdmin() {
            db.collection('settings').doc('dailySpecial').get().then(function(doc) {
                if (doc.exists) {
                    var d = doc.data();
                    document.getElementById('ds-active').checked = !!d.active;
                    document.getElementById('ds-title').value   = d.title || '';
                    document.getElementById('ds-desc').value    = d.description || '';
                    document.getElementById('ds-price').value   = d.price || '';
                    document.getElementById('ds-image').value   = d.imageUrl || '';
                }
            }).catch(function(e) { console.error('Load daily special error:', e); });
        }

        function saveDailySpecial() {
            var data = {
                active:      document.getElementById('ds-active').checked,
                title:       document.getElementById('ds-title').value.trim(),
                description: document.getElementById('ds-desc').value.trim(),
                price:       parseFloat(document.getElementById('ds-price').value) || 0,
                imageUrl:    document.getElementById('ds-image').value.trim(),
                updatedAt:   new Date().toISOString()
            };
            var msgEl = document.getElementById('ds-msg');
            db.collection('settings').doc('dailySpecial').set(data).then(function() {
                msgEl.style.display = 'block';
                msgEl.style.color = '#27ae60';
                msgEl.textContent = '✓ Daily special saved and published!';
                setTimeout(function() { msgEl.style.display = 'none'; }, 3000);
            }).catch(function(e) {
                msgEl.style.display = 'block';
                msgEl.style.color = '#e74c3c';
                msgEl.textContent = 'Error: ' + e.message;
            });
        }

        // ===== ETA PROMPT ON PREPARING =====
        // Wrap the existing setOrderStatus to inject ETA for 'preparing'
        var _origSetOrderStatus = typeof setOrderStatus !== 'undefined' ? setOrderStatus : null;
        window.setOrderStatusWithETA = function(orderId, status) {
            if (status === 'preparing') {
                var eta = prompt('Set ETA for this order (minutes):', '20');
                if (eta === null) return; // cancelled
                var etaMins = parseInt(eta) || 20;
                db.collection('orders').doc(orderId).update({
                    status: 'preparing',
                    preparingAt: new Date().toISOString(),
                    etaMinutes: etaMins
                }).then(function() {
                    showToast('Order marked as Preparing (ETA: ' + etaMins + ' min)');
                    loadOrders();
                }).catch(function(e) { showToast('Error: ' + e.message); });
            } else {
                if (typeof setOrderStatus === 'function') setOrderStatus(orderId, status);
            }
        };

    </script>
    <style>
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-8px); }
            50% { transform: translateX(8px); }
            75% { transform: translateX(-4px); }
        }
    </style>
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js').then(function(reg) { reg.update(); });
        }
    </script>
</body>
</html>
