rules_version = '2';

// =============================================================================
// AMOGHA CAFE — FIRESTORE SECURITY RULES
// =============================================================================
//
// IMPORTANT SECURITY NOTE:
// This app uses a custom phone+PIN authentication system, NOT Firebase Auth.
// Because of this, request.auth is always null and true row-level security
// (e.g. "user can only edit their own data") is NOT enforceable here.
//
// These rules provide the best protection achievable without Firebase Auth:
//   - Field validation on creates (required fields, correct types)
//   - DELETE blocked on all collections
//   - Admin-only collections (menu, specials, heroSlides, addons, testimonials,
//     socialPosts, settings) are read-only from client. Admin operations must
//     go through Firebase Console or a future Cloud Function with Admin SDK.
//   - Coupons: only usedCount can be updated (not discount/type/etc.)
//   - Gift cards: only balance and redeemedAt can be updated
//   - Reviews: immutable after creation
//
// To enable true row-level security in the future:
//   1. Migrate to Firebase Anonymous Auth or phone Auth
//   2. Add request.auth.uid == resource.data.phone checks
//   3. Add admin role via Custom Claims
// =============================================================================

service cloud.firestore {
  match /databases/{database}/documents {

    // -------------------------------------------------------------------------
    // HELPER FUNCTIONS
    // -------------------------------------------------------------------------

    function hasFields(fields) {
      return request.resource.data.keys().hasAll(fields);
    }

    function isString(val) {
      return val is string && val.size() > 0;
    }

    function isNumber(val) {
      return val is number;
    }

    // -------------------------------------------------------------------------
    // USERS
    // -------------------------------------------------------------------------
    match /users/{phone} {
      allow read: if true;
      allow create: if hasFields(['name', 'phone', 'pin', 'createdAt'])
                    && isString(request.resource.data.name)
                    && isString(request.resource.data.phone)
                    && isString(request.resource.data.pin)
                    && request.resource.data.phone == phone;
      allow update: if true;  // loyalty points, tier, order history, preferences
      allow delete: if false;
    }

    // -------------------------------------------------------------------------
    // ORDERS
    // -------------------------------------------------------------------------
    match /orders/{orderId} {
      allow read: if true;
      allow create: if hasFields(['items', 'total', 'customer', 'phone', 'status', 'createdAt'])
                    && isString(request.resource.data.customer)
                    && isString(request.resource.data.phone)
                    && isNumber(request.resource.data.total)
                    && request.resource.data.total > 0
                    && request.resource.data.items is list
                    && request.resource.data.items.size() > 0;
      allow update: if request.resource.data.diff(resource.data).affectedKeys()
                         .hasOnly(['status','kitchenStartedAt','preparingAt','etaMinutes','readyAt',
                                   'deliveredAt','scheduledFor','deliveryPerson','outForDeliveryAt']);
      allow delete: if false;
    }

    // -------------------------------------------------------------------------
    // MENU — read-only from client
    // Admin writes go through Firebase Console or Admin SDK Cloud Function.
    // -------------------------------------------------------------------------
    match /menu/{itemId} {
      allow read: if true;
      allow write: if false;
    }

    // -------------------------------------------------------------------------
    // SPECIALS — read-only from client
    // -------------------------------------------------------------------------
    match /specials/{specialId} {
      allow read: if true;
      allow write: if false;
    }

    // -------------------------------------------------------------------------
    // HERO SLIDES — read-only from client
    // -------------------------------------------------------------------------
    match /heroSlides/{slideId} {
      allow read: if true;
      allow write: if false;
    }

    // -------------------------------------------------------------------------
    // ADDONS — read-only from client
    // -------------------------------------------------------------------------
    match /addons/{addonId} {
      allow read: if true;
      allow write: if false;
    }

    // -------------------------------------------------------------------------
    // TESTIMONIALS — read-only from client
    // -------------------------------------------------------------------------
    match /testimonials/{tid} {
      allow read: if true;
      allow write: if false;
    }

    // -------------------------------------------------------------------------
    // SOCIAL POSTS — read-only from client
    // -------------------------------------------------------------------------
    match /socialPosts/{postId} {
      allow read: if true;
      allow write: if false;
    }

    // -------------------------------------------------------------------------
    // SETTINGS — read-only from client
    // -------------------------------------------------------------------------
    match /settings/{docId} {
      allow read: if true;
      allow write: if false;
    }

    // -------------------------------------------------------------------------
    // COUPONS
    // Only usedCount may be updated (prevents tampering with discount/type/etc.)
    // -------------------------------------------------------------------------
    match /coupons/{code} {
      allow read: if true;
      allow create: if false;
      allow update: if request.resource.data.diff(resource.data).affectedKeys()
                         .hasOnly(['usedCount']);
      allow delete: if false;
    }

    // -------------------------------------------------------------------------
    // GIFT CARDS
    // -------------------------------------------------------------------------
    match /giftCards/{code} {
      allow read: if true;
      allow create: if hasFields(['code', 'balance', 'recipientPhone', 'createdAt'])
                    && isNumber(request.resource.data.balance)
                    && request.resource.data.balance > 0;
      allow update: if request.resource.data.diff(resource.data).affectedKeys()
                         .hasOnly(['balance', 'redeemedAt']);
      allow delete: if false;
    }

    // -------------------------------------------------------------------------
    // REVIEWS — immutable after creation
    // -------------------------------------------------------------------------
    match /reviews/{reviewId} {
      allow read: if true;
      allow create: if hasFields(['rating', 'createdAt'])
                    && isNumber(request.resource.data.rating)
                    && request.resource.data.rating >= 1
                    && request.resource.data.rating <= 5;
      allow update: if false;
      allow delete: if false;
    }

    // -------------------------------------------------------------------------
    // RESERVATIONS
    // -------------------------------------------------------------------------
    match /reservations/{resId} {
      allow read: if true;
      allow create: if hasFields(['name', 'phone', 'date', 'time', 'partySize', 'status', 'createdAt'])
                    && isString(request.resource.data.name)
                    && isString(request.resource.data.phone)
                    && request.resource.data.partySize is int
                    && request.resource.data.partySize > 0;
      allow update: if true;  // admin/kitchen updates status
      allow delete: if false;
    }

    // -------------------------------------------------------------------------
    // INVENTORY — kitchen staff updates stock counts
    // -------------------------------------------------------------------------
    match /inventory/{itemId} {
      allow read: if true;
      allow create: if false;
      allow update: if request.resource.data.diff(resource.data).affectedKeys().hasOnly(['quantity'])
                    && request.resource.data.quantity >= 0;
      allow delete: if false;
    }

    // -------------------------------------------------------------------------
    // TABLES — status managed by kitchen/display
    // -------------------------------------------------------------------------
    match /tables/{tableId} {
      allow read: if true;
      allow create: if false;
      allow update: if request.resource.data.diff(resource.data).affectedKeys()
                         .hasOnly(['status','currentOrder','updatedAt']);
      allow delete: if false;
    }

    // -------------------------------------------------------------------------
    // MESSAGES — kitchen-FOH chat, immutable after creation
    // -------------------------------------------------------------------------
    match /messages/{msgId} {
      allow read: if true;
      allow create: if hasFields(['text', 'createdAt'])
                    && isString(request.resource.data.text);
      allow update: if false;
      allow delete: if false;
    }

    // -------------------------------------------------------------------------
    // NOTIFICATIONS — created by system, updated (mark as read) by client
    // -------------------------------------------------------------------------
    match /notifications/{notifId} {
      allow read: if true;
      allow create: if true;
      allow update: if request.resource.data.diff(resource.data).affectedKeys().hasOnly(['read'])
                    && request.resource.data.read == true;
      allow delete: if false;
    }

    // -------------------------------------------------------------------------
    // REFERRALS
    // -------------------------------------------------------------------------
    match /referrals/{refId} {
      allow read: if true;
      allow create: if hasFields(['code', 'referrerId', 'createdAt']);
      allow update: if request.resource.data.diff(resource.data).affectedKeys()
                         .hasOnly(['usageCount','credited']);
      allow delete: if false;
    }

    // -------------------------------------------------------------------------
    // CATERING INQUIRIES — write-only by clients, admin reads via Console
    // -------------------------------------------------------------------------
    match /cateringInquiries/{id} {
      allow create: if hasFields(['name','phone','eventType','guestCount','date'])
                    && isString(request.resource.data.name)
                    && isString(request.resource.data.phone);
      allow read, update, delete: if false;
    }

    // -------------------------------------------------------------------------
    // DELIVERY PERSONS — read by delivery app (PIN check), write only via Console/Admin SDK
    // -------------------------------------------------------------------------
    match /deliveryPersons/{phone} {
      allow read: if true;
      allow create, update, delete: if false;
    }

    // -------------------------------------------------------------------------
    // EXPENSES — admin-only, full read/write from admin panel
    // -------------------------------------------------------------------------
    match /expenses/{expenseId} {
      allow read: if true;
      allow create: if hasFields(['date', 'category', 'amount', 'description', 'createdAt'])
                    && isString(request.resource.data.date)
                    && isString(request.resource.data.category)
                    && isString(request.resource.data.description)
                    && isNumber(request.resource.data.amount)
                    && request.resource.data.amount > 0;
      allow update: if true;
      allow delete: if true;
    }

    // -------------------------------------------------------------------------
    // DEFAULT DENY — all other paths
    // -------------------------------------------------------------------------
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
